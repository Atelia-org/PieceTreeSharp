## 跨会话记忆文档
本文档(`./AGENTS.md`)会伴随每个 user 消消息注入上下文，是跨会话的外部记忆。完成一个任务、制定或调整计划时务必更新本文件，避免记忆偏差。请及时维护你的外部记忆文件，对齐你的关键认知和后续思路。

## 已知的工具问题
- 需要要删除请用改名替代，因为环境会拦截删除文件操作。
- 不要使用'insert_edit_into_file'工具，经常产生难以补救的错误结果。
- 当需要临时设置环境变量时，要显式用`export PIECETREE_DEBUG=0 && dotnet test ...`这样的写法，避免使用`PIECETREE_DEBUG=0 dotnet test ...`写法，后者会触发自动审批的命令行解析问题。

## 用户语言
请主要用简体中文与用户交流，对于术语/标识符等实体名称则优先用原始语言。

## 项目概览
**总体目标**是将位于“./ts”目录内的VS Code的无GUI编辑器核心移植为C#类库(dotnet 9.0 + xUnit)。核心目标是“./ts/src/vs/editor/common/model/pieceTreeTextBuffer”, 如果移植顺利后续可以围绕pieceTreeTextBuffer再移植diff/edit/cursor等其他部分。

## 移植方法宗旨
我们优先选择直接翻译TS原版而非自己重新实现一遍，适用于单元测试也适用于实现本身。仅当为了适配语言和运行时差异，不适宜“直译”TS原版的思路和关键设计时，才“custom reimplementation”。C#文件如果有TS原版对应，则应在文件头部注释说明。遇到冲突时，首先考虑与原版VS Code的TS代码对齐，包括单元测试、设计思路与关键实现。

**用途背景**是为工作在Agent系统中的LLM创建一种DocUI，类似TUI但是不是渲染到2D终端而是渲染为Markdown文本，UI元素被渲染为Markdown元素。渲染出的Markdown会被通过上下文工程注入LLM Context中。可以想象为“把LLM Context作为向LLM 展示信息的屏幕”。这需要高质量的Text建模、编辑、比较、查找、装饰功能。举例说明这里“装饰”的含义，例如我们要创建一个TextBox Widget来向LLM呈现可编辑文本，把原始文本和虚拟行号渲染为Markdown代码围栏，把光标/选区这些overlay元素渲染为插入文本中的Mark，并在代码围栏外用图例注解插入的光标/选区起点/终点Mark。像这些虚拟行号、光标/选区Mark，就是前面所说的“装饰”。后续有望用这条DocUI为LLM Agent 打造更加LLM Native & Friendly的编程IDE。

## 最新进展
- 2025-11-19：已评估 PieceTree 移植可行性并在 `./` 下创建 `PieceTree.sln`、`src/TextBuffer` 与 xUnit 测试骨架，提供最小 `PieceTreeBuffer` 占位实现及 README，等待从 TypeScript 逐步迁移核心逻辑。
- 2025-11-19：确认通过 `runSubAgent` 组建 AI Team 的协作模式——主 Agent 负责调度与消息转发，SubAgent 以 `agent-team/` 下的记忆文件维持认知，必要时共享聊天室文件实现“会议”。
- 2025-11-19：建立 AI Team 运作设施：`agent-team/ai-team-playbook.md`、SubAgent 记忆模板、任务看板、TS↔C# 类型映射草稿，以及 `docs/meetings` / `docs/sprints` 模板，便于按 `runSubAgent` 粒度规划执行。
- 2025-11-19：构建首批 SubAgent 角色（Planner、Investigator-TS、Porter-CS、QA-Automation、DocMaintainer），创建各自记忆文件、任务分配、Kickoff 会议纪要与 Sprint-00 计划。
- 2025-11-19：整理主 Agent 主循环与 SubAgent 协作方法论，形成 `agent-team/main-loop-methodology.md`，确保后续按固定迭代流程推进。
- 2025-11-19：在主循环中引入 DocMaintainer 三项职责（Info Proxy、Consistency Gate、Doc Gardener），更新 `agent-team/members/doc-maintainer.md` 以指导文档治理。
- 2025-11-19：召开“Org Self-Improvement”全员会议（`docs/meetings/meeting-20251119-org-self-improvement.md`），决定新增 Info-Indexer 角色、建立索引目录并启动组织自我完善 Sprint。
- 2025-11-19：创建 Info-Indexer 记忆文件、`agent-team/indexes/README.md`、`docs/sprints/sprint-org-self-improvement.md`，在任务板加入 OI 系列任务并更新主循环文档以包含索引钩子。
- 2025-11-19：完成 OI-002/OI-001/OI-003/OI-004，分别交付 `agent-team/indexes/core-docs-index.md`、`docs/reports/consistency/consistency-report-20251119.md`、runSubAgent 提示模板（主循环/Playbook/记忆模板）以及分层版 `agent-team/task-board.md`，全面引入 Info-Indexer changefeed 提醒。
- 2025-11-19：完成 PT-003（类型映射），`agent-team/type-mapping.md` 新增 Piece/PieceTreeNode/SearchContext/BufferRange 映射及 Porter-CS/QA 风险提示，并附 Diff Summary 供 Info-Indexer 消费。
- 2025-11-19：交付 PT-004.G1，`src/TextBuffer/Core` 接入 `PieceTreeBuilder`→`PieceTreeModel` 链路，`PieceTreeBuffer` 改为树驱动 façade 并记录增量编辑 TODO，`dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj`（4/4）通过且 Porting Log 更新。
- 2025-11-19：PT-005.G1 完成 QA 基线，`tests/TextBuffer.Tests/TestMatrix.md` 建立，`UnitTest1.cs` 扩展至 7 个 Plain/CRLF/Multi-chunk/metadata Fact，baseline `dotnet test`（7/7）与 S8~S10 TODO 均已记录。
- 2025-11-19：创建 `docs/reports/migration-log.md`，在更新 AGENTS / Sprint / Task Board 状态前须先查阅对应迁移日志行并同步 `agent-team/indexes/README.md#delta-2025-11-19` changefeed。
- 2025-11-19：确定以“Diff Brief → 实现 → TS 测试 → 单条日志”循环推进 PieceTree 迁移，并在 `docs/prompts/diff-driven-porting-prompt.md` 固化提示模板，引用 [`docs/reports/migration-log.md`](docs/reports/migration-log.md) 与 [`agent-team/indexes/README.md#delta-2025-11-19`](agent-team/indexes/README.md#delta-2025-11-19) 追踪每轮变更。
- 2025-11-19：PT-004.Positions 增加 `TextPosition` 与 `PieceTreeBuffer.GetPositionAt/GetOffsetAt` 等 API，并移植 TS prefix-sum 风格测试（详见 [`docs/reports/migration-log.md`](docs/reports/migration-log.md) 对应条目，changefeed 仍为 [`agent-team/indexes/README.md#delta-2025-11-19`](agent-team/indexes/README.md#delta-2025-11-19)）。
- 2025-11-19：PT-010 完成 CRLF Normalization 移植。Investigator-TS 分析了 `normalizeEOL` 与 Builder 差异，Porter-CS 落地了 `PieceTreeModel.NormalizeEOL` + `ChunkUtilities.NormalizeChunks` 流水线、BOM/Split-CRLF 处理及 `_eolNormalized` 优化，并补充了 3 个 TS 对应测试（CRLF 删除与 Normalization 优化验证），Tests (23/23) 通过。
- 2025-11-19：PT-011 完成 v1 阶段性验收。QA-Automation 验证了 RBTree 骨架 (PT-004) 与测试矩阵 (PT-005) 的完整性，确认 Insert/Delete/Search/Snapshot/Normalize 功能齐备且 23 个测试全通。PT-004/PT-005/PT-011 状态均更新为 Done。
- 2025-11-19：Phase 2 (TextModel & Interaction) 冲刺完成。通过 DMA 工作流连续交付了 TM-001 (Analysis), TM-002/3/4 (TextModel/Selection/Events), TM-005 (Cursor)。实现了 `TextModel` 包装器、`Selection` 结构体以及支持基础导航（上下左右）的 `Cursor` 类。所有 33 个测试用例（含新增的 10 个 TextModel/Cursor 测试）全部通过。
- 2025-11-19：Phase 3 (Diffing & Decorations) 冲刺完成。交付了 DF-001 (Analysis), DF-002 (Myers Diff), DF-003/4 (Decorations/IntervalTree), DF-005 (MarkdownRenderer)。实现了文本比较算法、装饰器存储（v1 List-based）以及 DocUI 的核心渲染器。所有 50 个测试用例全部通过。
- 2025-11-19：Phase 4 (Alignment & Audit) 冲刺完成。通过 AA-001~004 审计了 C# 实现与 TS 原版的差异，并执行了 AA-005/006 修复任务。解决了 Split CRLF 数据损坏风险、Search Cache 性能问题、Word Search 边界判定以及 Cursor Sticky Column 体验问题。所有 56 个测试用例全部通过。
- 2025-11-20：AA2-005 核心补丁交付（见 [`docs/reports/migration-log.md`](docs/reports/migration-log.md) & [`agent-team/indexes/README.md#delta-2025-11-20`](agent-team/indexes/README.md#delta-2025-11-20)），重新接入 `PieceTreeModel` CRLF 修复、聚合元数据回填、SearchCache 失效以及 PieceCount 统计，并新增 4 个 xUnit Fact 覆盖 CRLF/Metadata/Cache 场景；`dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj`（60/60）为最新基线。
- 2025-11-20：AA2-005 Undo/Redo & Options 补丁完成。`TextModel` 现包含 TS 同步的 `EditStack`、`pushEditOperations/pushEOL/setEOL/undo/redo` API，新增 `TextModelResolvedOptions`、`OnDidChangeOptions` / `OnDidChangeLanguage` 事件与 `DetectIndentation`，并在 `TextModelTests` 增补 Undo/EOL/Options/Language 6 个回归用例。`dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj`（66/66）结果记录于迁移日志 + changefeed。
- 2025-11-20：AA2-006 搜索/差异/装饰修复交付。升级 `PieceTreeSearcher`（Unicode 正则 + 单词分类）、`DiffComputer`（prettify & move 元数据）、`Decorations/IntervalTree`（stickiness/owner delta）、`TextModel` & `MarkdownRenderer` 事件消费。`dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj`（71/71）记录在 [`docs/reports/migration-log.md`](docs/reports/migration-log.md) 与 [`agent-team/indexes/README.md#delta-2025-11-20`](agent-team/indexes/README.md#delta-2025-11-20)。
- 2025-11-20：开启 Sprint 01（AA3）—— 创建 `docs/sprints/sprint-01.md`、`docs/reports/audit-checklist-aa3.md`，并将 Task Board 切换至 Phase 6（记录在 `agent-team/task-board.md` / `task-board-v5-archive.md`）。CL1~CL4 清单将通过 runSubAgent（Investigator → Porter → QA → Info-Indexer）串联。
- 2025-11-20：AA3-001（CL1 Investigator）完成。`agent-team/handoffs/AA3-001-Audit.md` 记录 F1~F5（creation options、语言配置事件、attached lifecycle、EditStack undo service、multi-range search），`docs/reports/audit-checklist-aa3.md#cl1` / Task Board 已更新，等待 AA3-003 Porter 落地。
- 2025-11-20：AA3-002（CL2 Investigator）完成。`agent-team/handoffs/AA3-002-Audit.md` 记录 F1~F3（ECMAScript regex、whole-word separators、surrogate pairs），`docs/reports/audit-checklist-aa3.md#cl2` / Task Board 已同步，等待 AA3-004 Porter 修复。
- 2025-11-20：AA3-005（CL3 Investigator）完成。`agent-team/handoffs/AA3-005-Audit.md` 梳理 Diff `LinesDiff` 数据模型、move detection、prettify/whitespace/timeout选项与 DocUI diff 装饰缺口，`docs/reports/audit-checklist-aa3.md#cl3`、Task Board 与 Sprint Log 均已更新，等待 AA3-006 Porter 修复。
- 2025-11-20：AA3-007（CL4 Investigator）完成。`agent-team/handoffs/AA3-007-Audit.md` 归档 DecorationOptions/DecorationsTrees/stickiness/MarkdownRenderer 的缺口，`docs/reports/audit-checklist-aa3.md#cl4`、Task Board 与 Sprint Log 均已同步，等待 AA3-008 Porter 修复。
- 2025-11-20：AA3-004（CL2 Porter）完成。`SearchTypes`/`PieceTreeSearcher`/`TextModelSearch` 现以 ECMAScript Regex + surrogate-safe wildcard/word separator parity运行，`agent-team/handoffs/AA3-004-Result.md`、`docs/reports/migration-log.md`、`agent-team/indexes/README.md#delta-2025-11-20` 均已登记，`dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj`（84/84）为最新基线。
- 2025-11-20：AA3-003（CL1 Porter）交付 TextModel 选项/语言/Undo/multi-range 搜索补丁，详情见 `agent-team/handoffs/AA3-003-Result.md`，`docs/reports/migration-log.md` 与 `agent-team/indexes/README.md#delta-2025-11-20` 均已登记；`dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj`（79/79）保持绿色。
- 2025-11-20：AA3-006（CL3 Porter）完成 `LinesDiff`/move parity —— `DiffComputer`/`DiffResult`/`DiffMove` 复刻 TS 数据模型并支持 whitespace/word/subword heuristics、timeout flag 与 move detection，`DiffTests` 扩充 4 个针对 inner change/move/timeout 的回归；`dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj`（80/80）。
- 2025-11-20：AA3-008（CL4 Porter）交付 Decorations/DocUI parity —— 新增 `DecorationsTrees`、`DecorationRangeUpdater`、owner-aware decoration 查询与 metadata 丰富的 `OnDidChangeDecorations` 事件，`MarkdownRenderer` 现支持 owner filter、注入文本、glyph/margin/minimap/overview 注解；`agent-team/handoffs/AA3-008-Result.md` + `docs/reports/migration-log.md` 记录，`dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj`（85/85）。
- 2025-11-20：AA3-009（QA）完成 —— `agent-team/handoffs/AA3-009-QA.md` 确认 decoration metadata round-trip、`forceMoveMarkers` stickiness parity 与 DocUI diff markers；`docs/reports/audit-checklist-aa3.md#cl4`、`tests/TextBuffer.Tests/TestMatrix.md`、`agent-team/task-board.md`、`docs/sprints/sprint-01.md` 一并刷新；`dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj`（88/88，沿用 changefeed `agent-team/indexes/README.md#delta-2025-11-20`）。
- 2025-11-20：AA3-003 / AA3-008 状态以 AA3-009 QA changefeed (`agent-team/indexes/README.md#delta-2025-11-20`) 为准正式切换为 Done，AGENTS / Sprint 01 / Task Board 现共用该 DocUI canonical pointer。 
- 2025-11-20：Sprint 02（AA4）立项 —— `agent-team/task-board.md` 切换至 Phase 7，新增 `docs/sprints/sprint-02.md` 与 `docs/reports/audit-checklist-aa4.md` 规划 CL5（Builder/Factory）、CL6（ChangeBuffer/CRLF/large edits）、CL7（Cursor word/snippet）、CL8（DocUI Find/Replace）；等待 Investigator runSubAgent (`AA4-001~004`) 输出 handoff。
- 2025-11-20：AA4-001（CL5 Investigator）完成 —— `agent-team/handoffs/AA4-001-Audit.md` 列出 F1~F6（chunk split/CRLF、BOM、metadata flags、factory API、DefaultEOL、normalize pipeline），`docs/reports/audit-checklist-aa4.md#cl5`/`agent-team/task-board.md`/`docs/sprints/sprint-02.md` 均更新为“Audit Complete – Awaiting Fix”，等待 AA4-005 Porter 实施。 
- 2025-11-20：AA4-002（CL6 Investigator）完成 —— `agent-team/handoffs/AA4-002-Audit.md` 汇总 change buffer reuse、`_lastChangeBufferPos`、CRLF repair、AverageBufferSize、LineFeed metadata、SearchCache 六项缺口，`docs/reports/audit-checklist-aa4.md#cl6`、`agent-team/task-board.md`、`docs/sprints/sprint-02.md` 同步为 “Audit Complete – Awaiting Fix”，后续交由 AA4-006 Porter 修复。
- 2025-11-21：AA4-007.BF1 完成 Snippet 多光标占位符死循环修复——`SnippetSession` 现持有 `ModelDecoration` 引用并在 `Next/PrevPlaceholder` 导航时实时读取 Range，避免 placeholders 被编辑后偏移导致无限循环。`export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter "FullyQualifiedName=PieceTree.TextBuffer.Tests.SnippetMultiCursorFuzzTests.SnippetAndMultiCursor_Fuzz_NoCrashesAndInvariantsHold" --nologo`（1/1）与全量 `dotnet test`（115/115）皆通过；详情记于 [`docs/reports/migration-log.md`](docs/reports/migration-log.md) `AA4-007.BF1` 行及 [`agent-team/indexes/README.md#delta-2025-11-21`](agent-team/indexes/README.md#delta-2025-11-21)。
- 2025-11-22：**Batch #1 – ReplacePattern** (AA4-008) 完成。Porter-CS 交付 `ReplacePattern.cs` (561L)、`DocUIReplaceController.cs` (119L) 与 `ReplacePatternTests.cs` (`tests/TextBuffer.Tests/ReplacePatternTests.cs`, 23 tests)；QA-Automation 验证全量测试 142/142 通过（新增 23 个 TS parity 测试）；Info-Indexer 发布 [`#delta-2025-11-22`](agent-team/indexes/README.md#delta-2025-11-22) 并同步迁移日志。详见 [`docs/reports/migration-log.md`](docs/reports/migration-log.md) Batch #1 条目。
- 2025-11-23：Batch #2 – FindModel Parity 完成。新增 `FindModel/FindDecorations/FindReplaceState` 与 39 个 TS parity 测试（辅助 4 个：LineCount/Regex/EmptyStringRegex），总测试数提升至 187/187；暂缓 4 个 multi-cursor selectAllMatches 相关用例到 Batch #3。迁移日志与 changefeed 指针：[`migration-log.md`](docs/reports/migration-log.md) 2025-11-23 Batch #2 行 & [`#delta-2025-11-23`](agent-team/indexes/README.md#delta-2025-11-23)。
- 2025-11-23：FR-01 / FR-02 微优化交付。`FindModel` 引入 `_ignoreModelContentChanged` 抑制 Replace/ReplaceAll 后双重 Research；`SearchTypes` 增加 10-entry `WordCharacterClassifierCache` 复用边界分类结果；测试基线保持 187/187。详见迁移日志 FR-01 / FR-02 行与 [`#delta-2025-11-23`](agent-team/indexes/README.md#delta-2025-11-23)。
- 2025-11-23：Sprint 03 R14 – **B3-FC-Core** 完成。新增 `DocUIFindController`（Start/FindReplace/NextSelection/Scope commands）、`FindControllerHostOptions`、Storage/Clipboard stubs 及 `DocUIFindControllerTests`（issue #1857/#3090/#6149/#41027/#9043/#27083/#58604/#38232）确保 DocUI 层与 VS Code `findController.test.ts` 核心场景对齐。TestMatrix/Sprint 03/Migration Log/Changefeed 记录 `#delta-2025-11-23-b3-fc-core`，全量测试 199/199 通过，FindController Scope/Clipboard 高级场景排入 R15。 
- 2025-11-23：Sprint 03 R15 – **B3-FC-Scope** 收尾 W1/W2：`DocUIFindController.Start` 仅在 `BuildSearchScope()` 返回非空范围时覆盖 `_state.SearchScope`，`NextSelectionMatchFindAction()` 在失败后必定 `Start()` + 重试，使 auto find-in-selection 在光标折叠时持续生效且 Ctrl/Cmd+F3 可在空白上唤起 widget。新增 `SearchScopePersistsWhenSelectionCollapses` / `NextSelectionMatchOnWhitespaceRevealsWidget`，`export PIECETREE_DEBUG=0 && dotnet test ... --filter DocUIFindControllerTests --nologo` 15/15 绿；log & changefeed：[`docs/reports/migration-log.md`](docs/reports/migration-log.md) `B3-FC-Scope` 行、[`agent-team/indexes/README.md#delta-2025-11-23-b3-fc-scope`](agent-team/indexes/README.md#delta-2025-11-23-b3-fc-scope)。
- 2025-11-23：Sprint 03 R15 – **B3-FC-RegexSeed**：`DocUIFindController` 的 Cmd+E/StartFindWithSelection 在 regex 模式下仅对单行种子做 `Regex.Escape`，多行选区保持原样并复用 TS `selectAllMatches` 行为；新增 `StartFindWithSelectionDoesNotEscapeRegexCharacters` 用例和 TestMatrix 记录，`dotnet test --filter DocUIFindControllerTests` 27/27 绿 + 全量 218/218。详见 [`docs/reports/migration-log.md`](docs/reports/migration-log.md) `B3-FC-RegexSeed` 行与 [`agent-team/indexes/README.md#delta-2025-11-23-b3-fc-regexseed`](agent-team/indexes/README.md#delta-2025-11-23-b3-fc-regexseed)。
- 2025-11-23：Sprint 03 R16 – **B3-Decor-INV**：Investigator-TS 对 `findDecorations.ts` / `modelDecorations.test.ts` / `findController.test.ts` 与 C# `FindDecorations.cs` / `TextModel.cs` / DocUI harness 逐项比对，输出 `agent-team/handoffs/B3-Decor-INV.md`。计划内容涵盖 range highlight & overview throttling、`TrackedRangeStickiness` 矩阵、`GetLineDecorations`/`GetAllDecorations` API、DocUI find decoration 覆盖，目标 delta `#delta-2025-11-23-b3-decor-stickiness`，Task Board 已加入 B3-Decor 行等待 Porter-CS 承接实现。 
- 2025-11-23：Sprint 03 R16 – **B3-Decor-Stickiness**：Porter-CS 补齐 `FindDecorations` range highlight 裁剪、overview throttling、scope normalization 与 minimap/overview 元数据，`TextModel` 暴露 `GetAllDecorations` / `GetLineDecorations` / `GetDecorationIdsByOwner`，并新增 `DecorationStickinessTests` + `DocUIFindDecorationsTests`（`DecorationTests` 也扩充 per-line / 事件 coverage）。`dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --nologo` 233/233，专项 filters（`DecorationStickinessTests` 4/4、`DocUIFindDecorationsTests` 6/6）已记录于 `tests/TextBuffer.Tests/TestMatrix.md` / [`docs/reports/migration-log.md`](docs/reports/migration-log.md)。Changefeed 将以 `#delta-2025-11-23-b3-decor-stickiness` 发布。
- 2025-11-23：Sprint 03 R18 – **B3-Decor-Stickiness-Review**：依照 Investigator 复审（CI-1/CI-2/CI-3 + W-1/W-2）去除 `_cachedFindScopes`、保留 scope 原始换行、把 overview throttling 与 host `ViewportHeightPx` 对齐，并改为 `TextModel.AllocateDecorationOwnerId()`；`DocUIFindDecorationsTests` 新增 scope newline/track edits/viewport throttling 用例，`TestMatrix` 全量基线 235/235，targeted `--filter DocUIFindDecorationsTests` 9/9、`--filter DecorationStickinessTests` 4/4。全部文档引用 `#delta-2025-11-23-b3-decor-stickiness-review`。 
- 2025-11-24：Sprint 03 R19 – **B3-FM-Scope**：修复 DocUI FindModel 在搜索范围发生编辑后未回填 decoration scope、以及多行 search scope 未按行首/行尾归一化的问题。`FindModel` 现在先应用一次 `_state.SearchScope` override，再回退到 `_decorations.GetFindScopes()`，并复刻 TS `_normalizeFindScopes` 逻辑（issue #27083）。新增 `DocUIFindModelTests.Test45/Test46` 验证范围跟踪与多行归一化，`tests/TextBuffer.Tests/TestMatrix.md` 记录 `#delta-2025-11-24-find-scope` targeted rerun（`export PIECETREE_DEBUG=0 && dotnet test ... --filter FullyQualifiedName~FindModelTests --nologo` 44/44），迁移日志与 changefeed 见 [`docs/reports/migration-log.md`](docs/reports/migration-log.md) / [`agent-team/indexes/README.md#delta-2025-11-24-find-scope`](agent-team/indexes/README.md#delta-2025-11-24-find-scope)。
- 2025-11-24：Batch #3 跟进 – **B3-FM Multi-Selection Plan**：为剩余 TS `findModel` Test07/08 multi-selection 场景建立协调文档 [`agent-team/handoffs/B3-FM-MultiSelection-Plan.md`](agent-team/handoffs/B3-FM-MultiSelection-Plan.md)，在 Task Board 新增 `B3-FM-MSel-INV`（Investigator 记录 overlap/wrap 语义并输出 `B3-FM-MultiSelection-Audit.md`）与 `B3-FM-MSel-PORT`（Porter 扩展 `TestEditorContext`/`FindModel`、迁移测试并更新 TestMatrix 以达 43/43 parity）。
- 2025-11-24：B3-FM scoped replace 修复完成 —— `FindModel.GetMatchesForReplace` 现复用 live scope hydration，`DocUIFindModelTests` 新增 **Test47_RegexReplaceWithinScopeUsesLiveRangesAfterEdit**，TestMatrix 记录 targeted rerun（45/45）。详见 [`docs/reports/migration-log.md`](docs/reports/migration-log.md) “B3-FM-ReplaceScope” 行与 [`agent-team/indexes/README.md#delta-2025-11-24-find-replace-scope`](agent-team/indexes/README.md#delta-2025-11-24-find-replace-scope)。
- 2025-11-24：Sprint 03 R19 – **B3 DocUI Staged Fixes**：`FindDecorations.Reset()` 不再清空 `_startPosition`，`IntervalTree.CollectOverlaps()` 支持零宽查询，`DocUIFindModelTests.Test48_FlushEditKeepsFindNextProgress` 与 `DocUIFindDecorationsTests.CollapsedCaretAtMatchStartReturnsIndex` 记录 flush-edit/caret overlap 回归。QA rerun：`export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter FullyQualifiedName~FindModelTests --nologo` 46/46、`--filter FullyQualifiedName~DocUIFindDecorationsTests --nologo` 9/9；`docs/reports/migration-log.md` 添加 B3-DocUI-StagedFixes 行，changefeed 指向 [`agent-team/indexes/README.md#delta-2025-11-24-b3-docui-staged`](agent-team/indexes/README.md#delta-2025-11-24-b3-docui-staged)，handoff 详见 `agent-team/handoffs/B3-DocUI-StagedFixes-20251124*.md`。
- 2025-11-24：Batch #3 – B3-FM multi-selection parity 完成：`TestEditorContext` 获取多选区 plumbing、`FindModel.SetSelections()` 保留主光标与 scope 排序、`DocUIFindModelTests.Test07/08` 重新启用并由 QA rerun `export PIECETREE_DEBUG=0 && dotnet test --filter "FullyQualifiedName~FindModelTests"`（48/48）与全量 242/242。详见 [`docs/reports/migration-log.md`](docs/reports/migration-log.md) “B3-FM-MultiSel” 行与 [`agent-team/indexes/README.md#delta-2025-11-24-b3-fm-multisel`](agent-team/indexes/README.md#delta-2025-11-24-b3-fm-multisel)。
- 2025-11-24：Sprint 03 R23~R27 —— **B3 PieceTree Fuzz Harness + Deterministic Suites** 全面完工：Investigator/Planner/Porter 依次交付 `agent-team/handoffs/B3-PieceTree-Fuzz-{INV,PLAN,Harness}.md`、`B3-PieceTree-Fuzz-Review-{PORT,QA}.md`，上线 env-seeded harness、`FuzzLogCollector`、`PieceTreeModel.AssertPieceIntegrity` 黑高校验与 TS “random test/delete/chunks” deterministic 套件（10/10）。`tests/TextBuffer.Tests/TestMatrix.md` 记录 `dotnet test --filter PieceTreeFuzzHarnessTests --nologo`（10/10）与全量 `export PIECETREE_DEBUG=0 && dotnet test -v m`（245→253/253）结果，迁移日志新增 “B3-PieceTree-Fuzz-Harness”“B3-PieceTree-Fuzz-Review” 行，对应 changefeed [`#delta-2025-11-23-b3-piecetree-fuzz`](agent-team/indexes/README.md#delta-2025-11-23-b3-piecetree-fuzz) / [`#delta-2025-11-24-b3-piecetree-fuzz`](agent-team/indexes/README.md#delta-2025-11-24-b3-piecetree-fuzz)。
- 2025-11-24：**B3-TestFailures Sentinel & GetLineContent 修复**：Porter-CS 将 `PieceTreeModel`/`PieceTreeNode` 切换为 per-model sentinel (`Sentinel` 属性 + `CreateSentinel()`)，`PieceTreeFuzzHarness`/`PieceTreeModelTests`/`UnitTest1` 改为复用 model sentinel；与此同时更新 `PieceTreeBaseTests` 与 `PieceTreeNormalizationTests` 断言 trimmed `GetLineContent` + 原始 `GetLineRawContent`，确保缓存/CRLF 正常。QA 跑 `export PIECETREE_DEBUG=0 && dotnet test -v m`（253/253）与针对 `PieceTreeBaseTests`、`PieceTreeNormalizationTests` 的过滤器；迁移日志 B3-TestFailures 行及 `tests/TextBuffer.Tests/TestMatrix.md` 均引用 [`#delta-2025-11-24-b3-sentinel`](agent-team/indexes/README.md#delta-2025-11-24-b3-sentinel) / [`#delta-2025-11-24-b3-getlinecontent`](agent-team/indexes/README.md#delta-2025-11-24-b3-getlinecontent)。
- 2025-11-25：**B3-PieceTree-Deterministic-CRLF** 完成 50/50 CRLF/delete/random/chunk 脚本复刻，`tests/TextBuffer.Tests/PieceTreeDeterministicTests.cs` 与 `Helpers/PieceTreeDeterministicScripts.cs` 接入集中脚本表，QA 以 `export PIECETREE_DEBUG=0 && dotnet test --filter PieceTreeDeterministicTests --nologo`（50/50，3.5s）+ `export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --nologo`（308/308，67.2s）记录基线。详见迁移日志 “B3-PieceTree-Deterministic-CRLF” 行、`tests/TextBuffer.Tests/TestMatrix.md` 最新 rerun 与 [`#delta-2025-11-25-b3-piecetree-deterministic-crlf`](agent-team/indexes/README.md#delta-2025-11-25-b3-piecetree-deterministic-crlf)。
- 2025-11-25：**B3-PieceTree-Snapshot** 让 `PieceTreeSnapshot.Read()` 单次遍历输出 BOM→piece 切片，并由 `TextModel.CreateSnapshot()` 加入保留 BOM 的 façade；新增 `SnapshotReader` helper + `PieceTreeSnapshotParityTests`（TS bug #45564 & immutable snapshot 1/2/3）。QA 运行 `export PIECETREE_DEBUG=0 && dotnet test --filter PieceTreeSnapshotParityTests --nologo`（4/4，1.7s）及全量 312/312；handoff 记录见 `agent-team/handoffs/B3-PieceTree-Snapshot-{PORT,QA}.md`，changefeed [`#delta-2025-11-25-b3-piecetree-snapshot`](agent-team/indexes/README.md#delta-2025-11-25-b3-piecetree-snapshot) 已广播。
- 2025-11-25：**B3-TextModel-Snapshot** 引入 `TextModelSnapshot` 包装器（64KB chunk 聚合、空块跳过、EOF 缓存），`TextModel.CreateSnapshot(bool preserveBom)` 现返回该 wrapper，并对 `PieceTreeSnapshotTests`、`PieceTreeSnapshotParityTests`、`PieceTreeDeterministicTests`、`PieceTreeSearchOffsetCacheTests` 做回归，同时新增 `TextModelSnapshotTests`（4/4）。QA 汇报一组 filters：`--filter TextModelSnapshotTests` 4/4、`--filter PieceTreeSnapshotTests` 2/2、`--filter PieceTreeSnapshotParityTests` 4/4、`--filter PieceTreeSearchOffsetCacheTests` 5/5、`--filter PieceTreeDeterministicTests` 50/50，加 `dotnet test --nologo`（321/321），详见 [`#delta-2025-11-25-b3-textmodel-snapshot`](agent-team/indexes/README.md#delta-2025-11-25-b3-textmodel-snapshot)。
- 2025-11-25：B3-PieceTree-Bom 覆盖新增 `PieceTreeBufferBomTests`（3 个 TS parity 场景）以验证 `PieceTreeBuffer.GetBom()` 暴露 UTF-8 BOM 元数据且 `GetText()` 不携带 `\uFEFF`，并记录 `PieceTreeBuffer.FromChunks` 首 chunk 仅含 BOM 的行为；详情见 [`docs/reports/migration-log.md#b3-piecetree-bom`](docs/reports/migration-log.md#b3-piecetree-bom)，changefeed 指向 [`agent-team/indexes/README.md#delta-2025-11-25-b3-bom`](agent-team/indexes/README.md#delta-2025-11-25-b3-bom)。
- 2025-11-25：**B3-SearchOffset** 将 TS search-offset cache 套件（render whitespace + 4 种归一化 EOL 插入）移植为 `PieceTreeSearchOffsetCacheTests`（5 Facts），并补充 `PieceTreeBufferAssertions.AssertSearchCachePrimed`。QA 以 `export PIECETREE_DEBUG=0 && dotnet test --filter PieceTreeSearchOffsetCacheTests --nologo`（5/5，4.3s）与全量 `export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --nologo`（324/324，58.2s）记录在 `tests/TextBuffer.Tests/TestMatrix.md`、迁移日志 [`docs/reports/migration-log.md#b3-searchoffset`](docs/reports/migration-log.md#b3-searchoffset) 与 `agent-team/handoffs/B3-PieceTree-SearchOffset-QA.md`；changefeed [`#delta-2025-11-25-b3-search-offset`](agent-team/indexes/README.md#delta-2025-11-25-b3-search-offset) 现为 canonical anchor。

- **状态更新提示：** 编辑本文件或引用 PT/OI 进度前，请先核对 `docs/reports/migration-log.md` 与 `agent-team/indexes/README.md#delta-2025-11-19` / `#delta-2025-11-20` / `#delta-2025-11-21` / `#delta-2025-11-22` / `#delta-2025-11-23` / `#delta-2025-11-23-b3-decor-stickiness` / `#delta-2025-11-23-b3-decor-stickiness-review` / `#delta-2025-11-23-b3-piecetree-fuzz` / `#delta-2025-11-24-b3-piecetree-fuzz` / `#delta-2025-11-24-find-scope` / `#delta-2025-11-24-find-replace-scope` / `#delta-2025-11-24-b3-docui-staged` / `#delta-2025-11-24-b3-sentinel` / `#delta-2025-11-24-b3-getlinecontent` / `#delta-2025-11-25-b3-piecetree-deterministic-crlf` / `#delta-2025-11-25-b3-piecetree-snapshot` / `#delta-2025-11-25-b3-textmodel-snapshot` / `#delta-2025-11-25-b3-bom` / `#delta-2025-11-25-b3-search-offset`，并在条目中附上两者的链接。