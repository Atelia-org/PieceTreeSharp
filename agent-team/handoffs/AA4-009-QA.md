# AA4-009 QA Report — CL5/CL6

## Summary (start)
- QA run initiated: 2025-11-21 by QA-Automation (AA4-009). Purpose: validate Porter-CS CL5 (AA4-005) and CL6 (AA4-006) implementations and capture failing CRLF split cases.
- Files reviewed: `agent-team/handoffs/AA4-005-Result.md`, `agent-team/handoffs/AA4-006-Result.md`, `agent-team/handoffs/AA4-006-Plan.md`, `docs/reports/audit-checklist-aa4.md`, `docs/sprints/sprint-02.md`.

## Test Matrix updates
- Updated `src/PieceTree.TextBuffer.Tests/TestMatrix.md` to include Porter-added tests (CL5/CL6) and QA verification entries; baseline updated below.

## dotnet test baseline
- Command: `dotnet test src/PieceTree.TextBuffer.Tests/PieceTree.TextBuffer.Tests.csproj --logger "console;verbosity=normal"`
- Baseline results (2025-11-21, re-run after AA4-006 fixes): Total tests: 105, Passed: 105, Failed: 0, Duration: ~2.1s
- CRLF-specific failing tests observed previously (`AA005Tests.TestSplitCRLF`, `PieceTreeModelTests.CRLF_RepairAcrossChunks`) have been validated and are now **Verified (pass)** after Porter-CS fixes and additional validation.

## Failing Tests: Details & Stack Trace

1) AA005Tests.TestSplitCRLF
   - Failure mode: throws System.ArgumentOutOfRangeException (length '-1') during call to `PieceTreeModel.GetLineRawContent`, which calls `GetContentFromNode`.
   - Stack trace (truncated):
     - PieceTreeModel.GetContentFromNode(PieceTreeNode x, Int32 relativeLineNumber, Int32 endOffset) — `src/PieceTree.TextBuffer/Core/PieceTreeModel.Search.cs:line 284`
     - PieceTreeModel.GetLineRawContent(Int32 lineNumber, Int32 endOffset) — `src/PieceTree.TextBuffer/Core/PieceTreeModel.Search.cs:line 239`
     - PieceTree.TextBuffer.Tests.AA005Tests.TestSplitCRLF() — `src/PieceTree.TextBuffer.Tests/AA005Tests.cs:line 35`
   - Observed values: negative substring length in `PieceTreeModel.GetContentFromNode` indicates incorrect computed start/end offsets for node/line sub-slices.
   - Minimal repro (single command):
       ```bash
       cd /mnt/e/repos/microsoft/vscode
       dotnet test src/PieceTree.TextBuffer.Tests/PieceTree.TextBuffer.Tests.csproj --no-build --filter "FullyQualifiedName=PieceTree.TextBuffer.Tests.AA005Tests.TestSplitCRLF" --logger "console;verbosity=normal"
       ```
   - Repro steps (code paths): see `AA005Tests.TestSplitCRLF` — `CreateModel("")` -> `Insert(0, "A\r")` -> `Insert(2, "\nB")` -> `GetLineRawContent(1)` triggers error

2) PieceTreeModelTests.CRLF_RepairAcrossChunks
   - Failure mode: `Assert.Equal(1, buffer.InternalModel.TotalLineFeeds)` expected 1 linefeed (CRLF) but observed 2. That indicates CRLF pairs across chunk boundary were not repaired/normalized correctly.
   - Stack trace: `src/PieceTree.TextBuffer.Tests/PieceTreeModelTests.cs:line 92`.
   - Minimal repro (single command):
       ```bash
       cd /mnt/e/repos/microsoft/vscode
       dotnet test src/PieceTree.TextBuffer.Tests/PieceTree.TextBuffer.Tests.csproj --no-build --filter "FullyQualifiedName=PieceTree.TextBuffer.Tests.PieceTreeModelTests.CRLF_RepairAcrossChunks" --logger "console;verbosity=normal"
       ```
   - Repro steps (code paths): `PieceTreeBuffer.FromChunks(new[] { "Hello\r", "\nWorld" })` -> evaluate `TotalLineFeeds` -> (optional: invoke FixCRLF reflectively) -> Check `TotalLineFeeds` and `GetLineRawContent`

## CRLF Fuzz Harness run
- Action: The CRLF-oriented fuzz test suite (`src/PieceTree.TextBuffer.Tests/CRLFFuzzTests.cs`) contains three facts:
  1. `LargeInsert_HugePayload` — large insert > Chunk size
  2. `CRLF_SplitAcrossNodes` — `FromChunks` CRLF split
  3. `CRLF_RandomFuzz_1000` — 1000-iteration fuzz focusing on CR/LF insertions and random edits
-- Result: All three fuzz tests passed locally (3 tests passed). After re-running the CRLF-specific tests and fuzz harness multiple times, `AA005Tests.TestSplitCRLF` and `PieceTreeModelTests.CRLF_RepairAcrossChunks` passed deterministically. No repro of previously failing CRLF edge cases was observed during repeated runs.

## Verification permutations (executed)
1) Large insert (>DefaultChunkSize)
   - Verified via `CRLFFuzzTests.LargeInsert_HugePayload` and `PieceTreeBuilderTests.CreateNewPieces_SplitsLargeInsert`; behavior correct.
2) CRLF split across nodes
   - `CRLF_SplitAcrossNodes` passed when left alone, but `CRLF_RepairAcrossChunks` failed when further internal `FixCRLF` / deletion/insertion was invoked, implying a bug in the repair path.
3) Random fuzz (1000 iterations) focusing on CRLF
   - `CRLF_RandomFuzz_1000` passed (no exceptions and buffer text matched expected string builder). The CRLF randomized fuzz harness was run multiple times with deterministic seeds and showed no repro.

- ## Observations / Hypothesis
- The initial builder/factory CRLF splitting on chunk creation appears to produce the correct `TotalLineFeeds` in many cases (some tests pass). After the Porter-CS CRLF boundary fixes and improved `FixCRLF` logic, `GetLineRawContent` and `ComputeBufferMetadata` arithmetic errors that caused negative substring lengths or unexpected linefeed counts no longer repro under repeated test and fuzz runs.
- Hypothesis: `GetContentFromNode` or `GetLineRawContent` has an off-by-one or off-range calculation when a CRLF sequence spans piece boundaries, especially after edits or explicit invocations of the `FixCRLF` routine.

## Suggested follow-up actions for Porter-CS (prioritized)
1) Investigate `PieceTreeModel.GetContentFromNode` for boundary/offset arithmetic: ensure computed `startIndex` and `length` are within `0..string.Length` when reading slices; add defensive checks and logging for negative lengths.
2) Inspect `FixCRLF` logic for cross-node CRLF merge behavior: verify it updates node piece indices and `LineFeedCount` properly and doesn't leave stale metadata causing counting mismatches.
3) Add more targeted unit tests that exercise explicit `FixCRLF` invocation post-chunk assembly and verify `GetLineRawContent` and `TotalLineFeeds` invariants.
4) Add logging and assertions in `GetContentFromNode` to detect erroneous arithmetic early and make tests fail with more helpful messages.
5) Consider adding `CRLF` property test harness which performs targeted CRLF insert/delete operations across chunk boundaries and reports the exact buffer content on failure to help reproduce.

## Minimal reproduction (developer) instructions
1) Clone repo (or use workspace):
    ```bash
    cd /mnt/e/repos/microsoft/vscode
    dotnet test src/PieceTree.TextBuffer.Tests/PieceTree.TextBuffer.Tests.csproj --no-build --filter "FullyQualifiedName=PieceTree.TextBuffer.Tests.AA005Tests.TestSplitCRLF" --logger "console;verbosity=normal"
    ```
2) Alternatively, run a single test and capture the full stack trace: `--filter FullyQualifiedName=...`.
3) To reproduce step-by-step in repl or minimal harness:
    - Create the model: `CreateModel("")`
    - Insert `A\r` at start
    - Insert `\nB` after CR
    - Call `GetLineRawContent(1)`
    - Observe OutOfRange exception

## Attached logs & stack traces
- See `agent-team/handoffs/AA4-009-QA.md` and `src/PieceTree.TextBuffer.Tests/TestMatrix.md` for exact run baseline and failing test names. Relevant logs included in this file entry.

## Next steps (QA)
1) Notify Porter-CS with this report; link to failing tests & include stacks/commands. FYI sample commands above.
2) Request fix for `FixCRLF`/`GetLineRawContent` area; share the minimal reproducer and failing inputs.
3) After Porter fixes: performed re-run — full `dotnet test` run completed with 105/105 green. Reran CRLF fuzz harness multiple times and ran the CRLF-specific tests twice each to confirm stability. No flakiness observed.
4) Update `TestMatrix.md` with additional CRLF-focused bingo test cases and the final baseline counts.

## Wrap up (current)
- QA started 2025-11-21, completed re-run verification for AA4-006 on 2025-11-21. Test harness added for CRLF fuzzing (`CRLFFuzzTests.cs`), `TestMatrix.md` updated, and full test baseline now reports 105/105 passing. Previously failing CRLF tests are now passing (verified). No new CRLF regressions were found during fuzzing or targeted re-runs.

## Final QC
- **QA Verified (CL6):** Porter-CS fixes for AA4-006 validated by QA — full test suite green (105/105) and CRLF fuzz/targeted tests verified. Task board updated: `AA4-006` marked as *Porter Complete – QA Verified*.
- **Artifacts / Logs:** `~/aa4_006_crlf_specific_reruns.log`, `~/aa4_006_fuzz_reruns.log`, `~/aa4_006_full_rerun.log` (local to the QA runner session).
