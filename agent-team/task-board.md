# Task Board - Phase 7: Alignment & Audit R4

**Goal:** 启动第四轮 TS↔C# 对照审核，聚焦 PieceTree Builder/ChangeBuffer、增量编辑、Cursor WordOps 与 DocUI Find/Replace 管线，继续以“发现→修复→验证”闭环巩固 DocUI-ready 质量。

**Changefeed Reminder:** 更新任务状态前先读取 `agent-team/indexes/README.md#delta-2025-11-20`，必要时请求 Info-Indexer 发布新 delta，保持与 `docs/reports/migration-log.md` 同步。

## Alignment & Audit R4 (AA4/OI)

| ID | Description | Owner | Key Artifacts | runSubAgent Budget | Status | Latest Update |
| --- | --- | --- | --- | --- | --- | --- |
| AA4-001 | Investigator：CL5（PieceTree Builder & Factory parity）对照，输出差异清单 | Investigator-TS | `ts/src/vs/editor/common/model/pieceTreeTextBuffer/pieceTreeTextBufferBuilder.ts`<br>`ts/src/vs/editor/common/model/pieceTreeTextBuffer/pieceTreeBase.ts`<br>`src/TextBuffer/Core/PieceTreeBuilder.cs`<br>`docs/reports/audit-checklist-aa4.md#cl5`<br>`agent-team/handoffs/AA4-001-Audit.md` | 2 | Done | `AA4-001-Audit.md` 交付 F1~F6（chunk split/CRLF、BOM、metadata flags、factory API、DefaultEOL heuristics、normalize pipeline）；等待 AA4-005 Porter 修复。 |
| AA4-002 | Investigator：CL6（ChangeBuffer/CRLF/large edits）对照，输出差异清单 | Investigator-TS | `ts/src/vs/editor/common/model/pieceTreeTextBuffer/pieceTreeBase.ts`<br>`src/TextBuffer/Core/PieceTreeModel.Edit.cs`<br>`docs/reports/audit-checklist-aa4.md#cl6`<br>`agent-team/handoffs/AA4-002-Audit.md` | 2 | Done | `AA4-002-Audit.md` 完成 F1~F6（change buffer reuse、_lastChangeBufferPos、CRLF 修复、AverageBufferSize、LineFeed metadata、SearchCache），CL6 checklist 标记为 Audit Complete。 |
| AA4-003 | Investigator：CL7（Cursor word/snippet/multi-selection 语义）对照 | Investigator-TS | `ts/src/vs/editor/common/controller/cursor.ts`<br>`ts/src/vs/editor/common/controller/cursorWordOperations.ts`<br>`src/TextBuffer/Cursor/Cursor.cs`<br>`docs/reports/audit-checklist-aa4.md#cl7`<br>`agent-team/handoffs/AA4-003-Audit.md` | 2 | Planned | 需记录 word 左右移动、expand select、column selection、snippet tabstop stickiness 等缺口。 |
| AA4-004 | Investigator：CL8（DocUI Find/Replace + Decorations 管线）对照 | Investigator-TS | `ts/src/vs/editor/contrib/find/browser/findController.ts`<br>`ts/src/vs/editor/contrib/find/browser/findDecorations.ts`<br>`src/TextBuffer/TextModelSearch.cs`<br>`src/TextBuffer/Rendering/MarkdownRenderer.cs`<br>`docs/reports/audit-checklist-aa4.md#cl8`<br>`agent-team/handoffs/AA4-004-Audit.md` | 2 | Planned | 目标：梳理 TS FindController 的 delta decorations / owner 策略与 C# DocUI 的缺口，含 captureMatches overlays。 |
| AA4-005 | Porter：落实 CL5 修复（Builder/Factory 元数据 + getFirstLineText API），同步迁移日志 | Porter-CS | `src/TextBuffer/Core/PieceTreeBuilder.cs`<br>`src/TextBuffer/Core/ChunkUtilities.cs`<br>`src/TextBuffer/Core/PieceTreeTextBufferFactory.cs`<br>`docs/reports/audit-checklist-aa4.md#cl5`<br>`agent-team/handoffs/AA4-005-Result.md` | 3 | Done | Builder/factory parity landed（chunk split、BOM/metadata、DefaultEOL/normalize pipeline）；QA verified and included in delta `agent-team/indexes/README.md#delta-2025-11-21` (see `docs/reports/migration-log.md`); Handoff: `agent-team/handoffs/AA4-005-Result.md`. |
| AA4-006 | Porter：落实 CL6 修复（ChangeBuffer/CRLF/大文本拆分） | Porter-CS | `src/TextBuffer/Core/PieceTreeModel.cs`<br>`src/TextBuffer/Core/PieceTreeModel.Edit.cs`<br>`src/TextBuffer/Core/ChunkUtilities.cs`<br>`docs/reports/audit-checklist-aa4.md#cl6`<br>`agent-team/handoffs/AA4-006-Plan.md`<br>`agent-team/handoffs/AA4-006-Result.md` | 3 | Done | CL6 wrap-up: change-buffer reuse + `_lastChangeBufferPos` tracking, targeted metadata rebuild/`AssertPieceIntegrity`, deterministic CRLF fuzz logging, and tightened search-cache invalidations. See `agent-team/handoffs/AA4-006-Result.md` (2025-11-21 update) & refreshed `TestMatrix.md`; delta to be rolled into the next OI-011 sweep. |
| AA4-007 | Porter：落实 CL7 修复（Cursor word/snippet/multi-select） | Porter-CS | `src/TextBuffer/Cursor`<br>`src/TextBuffer/TextModel.cs`<br>`docs/reports/audit-checklist-aa4.md#cl7`<br>`agent-team/handoffs/AA4-007-Result.md` | 3 | Planned | 按 Investigator 输出扩展 Cursor API（word 左右、选词/选行、column 选择、snippet stickiness）并新增测试。 |
| AA4-008 | Porter：落实 CL8 修复（DocUI Find/Replace & Decorations） | Porter-CS | `src/TextBuffer/TextModelSearch.cs`<br>`src/TextBuffer/Decorations`<br>`src/TextBuffer/Rendering/MarkdownRenderer.cs`<br>`docs/reports/audit-checklist-aa4.md#cl8`<br>`agent-team/handoffs/AA4-008-Result.md` | 3 | ✅ Done | [`#delta-2025-11-22`](../indexes/README.md#delta-2025-11-22) | 2025-11-22 | Batch #1 – ReplacePattern：23 tests, 142/142 通过 |
| AA4-009 | QA：扩展 Builder/ChangeBuffer/Cursor/DocUI 测试矩阵，记录最新 `dotnet test` 基线 | QA-Automation | `tests/TextBuffer.Tests/`<br>`docs/reports/audit-checklist-aa4.md`<br>`agent-team/handoffs/AA4-009-QA.md` | 2 | Done | QA completed: `export PIECETREE_DEBUG=0 && dotnet test ... --nologo` 119/119 baseline + builder/factory spot-check + deterministic CRLF fuzz rerun（均记录于 `agent-team/handoffs/AA4-009-QA.md` 与 `TestMatrix.md`）；changefeed `agent-team/indexes/README.md#delta-2025-11-21` 已广播。 |
| OI-011 | Info-Indexer：AA4 changefeed & 索引同步，确保 AGENTS/Sprint/Task Board 对齐 | Info-Indexer | `agent-team/indexes/README.md`<br>`docs/sprints/sprint-02.md`<br>`docs/reports/migration-log.md` | 1 | Planned | 新增 `#delta-2025-11-20` 之后的 AA4 delta，广播到 AGENTS / Sprint 02 / Task Board。 |

## Batch #2 – FindModel Core (B2)

| ID | Description | Owner | Key Artifacts | runSubAgent Budget | Status | Latest Update |
| --- | --- | --- | --- | --- | --- | --- |
| B2-INV | Investigator：WordSeparator 规格调研 + FindWidget 测试路径定位 | Investigator-TS | `ts/src/vs/editor/contrib/find/`<br>`ts/src/vs/editor/common/core/wordHelper.ts`<br>`agent-team/handoffs/B2-INV-Result.md`<br>`docs/plans/ts-test-alignment.md#appendix-b` | 2 | ✅ Done | 2025-11-22 | WordSeparator 规格已补全（Appendix B），FindWidget 测试路径已定位（无专用 DOM harness），Batch #2 依赖清单已输出（Appendix C）。 |
| B2-001 | Porter：创建 FindReplaceState/FindDecorations stubs | Porter-CS | `src/TextBuffer/DocUI/FindReplaceState.cs`<br>`src/TextBuffer/DocUI/FindDecorations.cs`<br>`agent-team/handoffs/B2-001-Result.md` | 2 | ✅ Done | 2025-11-23 | 最小化 stub 支持 FindModel 测试（状态机 + decoration hooks）；详见 [B2-Final-QA](handoffs/B2-Final-QA.md)。 |
| B2-002 | Porter：实现 FindModel 核心逻辑（search + replace） | Porter-CS | `src/TextBuffer/DocUI/FindModel.cs`<br>`agent-team/handoffs/B2-002-Result.md` | 3 | Done | 2025-11-23 | ✅ 2025-11-23 完成，187/187 测试通过，详见 [B2-Final-QA](handoffs/B2-Final-QA.md) |
| B2-003 | QA：迁移 findModel.test.ts + 创建 DocUI harness | QA-Automation | `tests/TextBuffer.Tests/DocUI/DocUIFindModelTests.cs`<br>`tests/TextBuffer.Tests/DocUI/LineCountTest.cs`<br>`tests/TextBuffer.Tests/DocUI/RegexTest.cs`<br>`tests/TextBuffer.Tests/DocUI/EmptyStringRegexTest.cs`<br>`agent-team/handoffs/B2-003-QA.md` | 3 | ✅ Done | 2025-11-23 | Harness：`DocUI/TestEditorContext.cs`；FindModel parity 39/43（其余 4 个 multi-cursor 用例移至 Batch #3）。 |
| B2-004 | Info-Indexer：Batch #2 changefeed 发布 | Info-Indexer | `agent-team/indexes/README.md#delta-2025-11-23`<br>`docs/reports/migration-log.md`<br>`agent-team/handoffs/B2-004-Result.md` | 1 | ✅ Done | 2025-11-23 | Changefeed `#delta-2025-11-23` 登记 7 个新文件 + 187 测试（142→187，+45）；Task Board/Sprint/AGENTS 更新前均引用此 delta。 |
| B2-005 | DocMaintainer：Batch #2 文档同步 | DocMaintainer | `AGENTS.md`<br>`docs/sprints/sprint-02.md`<br>`agent-team/task-board.md`<br>`docs/plans/ts-test-alignment.md`<br>`tests/TextBuffer.Tests/TestMatrix.md`<br>`agent-team/handoffs/B2-005-Result.md` | 1 | ✅ Done | 2025-11-23 | 文档面同步（AGENTS、Sprint 02、Task Board、TS 计划、TestMatrix、BATCH2_SUMMARY）；详见 [B2-005-Result](handoffs/B2-005-Result.md)。 |

## Batch #3 – DocUI Find & Decorations (B3)

| ID | Description | Owner | Key Artifacts | runSubAgent Budget | Status | Latest Update |
| --- | --- | --- | --- | --- | --- | --- |
| B3-FM | Porter：SelectAllMatches 多光标语义对齐 | Porter-CS | `src/TextBuffer/DocUI/FindModel.cs`<br>`tests/TextBuffer.Tests/DocUI/DocUIFindModelTests.cs`<br>`agent-team/handoffs/B3-FM-Result.md` | 1 | ✅ Done | `#delta-2025-11-23-b3-fm` – FM-01/FM-02 tests landed，`dotnet test` 186/186；后续 scoped replace 修复见 `#delta-2025-11-24-find-replace-scope`（Test47, 45/45 targeted rerun）。 |
| B3-FM-MSel-INV | Investigator：DocUI multi-selection find parity brief (TS Test07/08) | Investigator-TS | `ts/src/vs/editor/contrib/find/test/browser/findModel.test.ts`<br>`agent-team/handoffs/B3-FM-MultiSelection-Plan.md` | 1 | ✅ Done | Scope audit + overlap/wrap matrices delivered via [`agent-team/handoffs/B3-FM-MultiSelection-Audit.md`](handoffs/B3-FM-MultiSelection-Audit.md); findings now tracked under [`#delta-2025-11-24-b3-fm-multisel`](../indexes/README.md#delta-2025-11-24-b3-fm-multisel). |
| B3-FM-MSel-PORT | Porter：Implement multi-selection scopes + tests | Porter-CS | [`src/TextBuffer/DocUI/FindModel.cs`](../src/TextBuffer/DocUI/FindModel.cs)<br>[`tests/TextBuffer.Tests/DocUI/TestEditorContext.cs`](../tests/TextBuffer.Tests/DocUI/TestEditorContext.cs)<br>[`tests/TextBuffer.Tests/DocUI/DocUIFindModelTests.cs`](../tests/TextBuffer.Tests/DocUI/DocUIFindModelTests.cs)<br>`agent-team/handoffs/B3-FM-MultiSelection-Plan.md` | 2 | ✅ Done | Multi-selection plumbing + Test07/08 parity landed; see [`agent-team/handoffs/B3-FM-MultiSelection-PORT.md`](handoffs/B3-FM-MultiSelection-PORT.md), [`agent-team/handoffs/B3-FM-MultiSelection-QA.md`](handoffs/B3-FM-MultiSelection-QA.md), and changefeed [`#delta-2025-11-24-b3-fm-multisel`](../indexes/README.md#delta-2025-11-24-b3-fm-multisel). |
| B3-FSel | Porter：`getSelectionSearchString` 复刻 | Porter-CS | `src/TextBuffer/DocUI/FindUtilities.cs`<br>`tests/TextBuffer.Tests/DocUI/DocUIFindSelectionTests.cs`<br>`agent-team/handoffs/B3-FSel-Result.md` | 1 | ✅ Done | `#delta-2025-11-23-b3-fsel` – selection seeding三场景覆盖，189/189 绿。 |
| B3-FC-Core | Porter：DocUI FindController 核心命令 | Porter-CS | `src/TextBuffer/DocUI/DocUIFindController.cs`<br>`tests/TextBuffer.Tests/DocUI/DocUIFindControllerTests.cs`<br>`agent-team/handoffs/B3-FC-Result.md` | 1 | ✅ Done | `#delta-2025-11-23-b3-fc-core` – Cmd+F/F3/ReplaceAll 等 10 tests，199/199 绿。 |
| B3-FC-Scope | Porter：searchScope lifecycle + Ctrl/Cmd+F3 修复 | Porter-CS | `src/TextBuffer/DocUI/DocUIFindController.cs`<br>`tests/TextBuffer.Tests/DocUI/DocUIFindControllerTests.cs`<br>`agent-team/handoffs/B3-FC-Review.md` | 1 | ✅ Done | `#delta-2025-11-23-b3-fc-scope` – scope persistence & whitespace widget fixes，15/15 targeted tests。 |
| B3-FC-Lifecycle | Porter：widget lifecycle / Cmd+E / regex seed | Porter-CS | `src/TextBuffer/DocUI/DocUIFindController.cs`<br>`tests/TextBuffer.Tests/DocUI/DocUIFindControllerTests.cs`<br>`tests/TextBuffer.Tests/DocUI/DocUIFindSelectionTests.cs`<br>`agent-team/handoffs/B3-FC-Review.md` | 1 | ✅ Done | `#delta-2025-11-23-b3-fc-lifecycle` + `#delta-2025-11-23-b3-fc-regexseed` – reseed、replace 折叠、Cmd+E 多行、Regex 转义 parity，218/218 baseline。 |
| B3-Decor | Porter：FindDecorations stickiness + DocUI overlay parity | Porter-CS | `src/TextBuffer/DocUI/FindDecorations.cs`<br>`src/TextBuffer/TextModel.cs`<br>`tests/TextBuffer.Tests/DecorationTests.cs`<br>`tests/TextBuffer.Tests/DecorationStickinessTests.cs`<br>`tests/TextBuffer.Tests/DocUI/DocUIFindDecorationsTests.cs`<br>`agent-team/handoffs/B3-Decor-INV.md`<br>`agent-team/handoffs/B3-Decor-PORTER.md`<br>`agent-team/handoffs/B3-Decor-Stickiness-Review.md` | 2 | ✅ Done | `#delta-2025-11-23-b3-decor-stickiness-review` – 关闭 CI-1/CI-2/CI-3 + W-1/W-2（live scopes、换行保留、viewport-aware overview、动态 owner），DocUI tests 扩展至 9/9。QA：`dotnet test ... --nologo` 235/235，`--filter DocUIFindDecorationsTests` 9/9，`--filter DecorationStickinessTests` 4/4。 |
| B3-DocUI-Staged | Porter：DocUI staged fixes（FindDecorations reset + caret overlap） | Porter-CS | `src/TextBuffer/DocUI/FindDecorations.cs`<br>`src/TextBuffer/Decorations/IntervalTree.cs`<br>`tests/TextBuffer.Tests/DocUI/DocUIFindModelTests.cs`<br>`tests/TextBuffer.Tests/DocUI/DocUIFindDecorationsTests.cs`<br>`agent-team/handoffs/B3-DocUI-StagedFixes-20251124.md`<br>`agent-team/handoffs/B3-DocUI-StagedFixes-QA-20251124.md` | 1 | ✅ Done | `#delta-2025-11-24-b3-docui-staged` – Reset 保留 `_startPosition`、IntervalTree 捕获零宽，新增 Test48 + CollapsedCaret 回归；QA rerun `--filter FullyQualifiedName~FindModelTests` 46/46、`--filter FullyQualifiedName~DocUIFindDecorationsTests` 9/9。 |

## Reference & Logs

- `agent-team/task-board-v6-archive.md` – Phase 6 (Alignment & Audit R3) 历史。
- `agent-team/task-board-v5-archive.md` – Phase 5 历史。
- `agent-team/task-board-v4-archive.md` / `-v3` / `-v2` / `-v1` – 更早阶段历史。
- `docs/sprints/sprint-02.md` – Sprint 02 目标/计划（新建）。
- `docs/reports/audit-checklist-aa4.md` – CL5~CL8 清单（新建）。
- `agent-team/indexes/README.md` – canonical Info-Indexer changefeed。
- `docs/reports/migration-log.md` – full migration audit trail。
- `AGENTS.md` – cross-session log。
