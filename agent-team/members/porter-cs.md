# Porter-CS Memory

## Role & Mission
- **Focus Area:** 将 TypeScript PieceTree 逻辑逐步移植到 `src/TextBuffer`
- **Primary Deliverables:** C# 源码、xUnit 覆盖、性能基准脚手架
- **Key Stakeholders:** Investigator-TS、QA-Automation、DocMaintainer

## Onboarding Summary (2025-11-19)
- 阅读/速览：`AGENTS.md` 时间线、`agent-team/ai-team-playbook.md`、`agent-team/main-loop-methodology.md`、两份 2025-11-19 会议纪要、`docs/sprints/sprint-00.md`、`docs/sprints/sprint-org-self-improvement.md`、`agent-team/task-board.md`（PT-004 聚焦）。
- 立即 C# 目标：根据 PT-004 在 `src/TextBuffer/Core` 完成 PieceTreeNode + 红黑树骨架，并按 Investigator-TS 的类型映射预留接口。
- 代码与测试记录：所有实现/测试日志将写入 `src/TextBuffer/README.md` 的“Porting Log”子节，并在本文件 Worklog 中附指针。

## Knowledge Index
| Topic | Files / Paths | Notes |
| --- | --- | --- |
| Core Library Skeleton | src/TextBuffer/Core | 主要的 PieceTree 结构放置点 |
| Buffer Entry Point | src/TextBuffer/PieceTreeBuffer.cs | 提供公共 API，需逐步替换占位实现 |
| Tests | tests/TextBuffer.Tests/UnitTest1.cs | 先期可扩展基础 xUnit 框架 |
| Type Mapping | agent-team/type-mapping.md | TS↔C# 结构别名及字段含义 |
| TS Source | ts/src/vs/editor/common/model/pieceTreeTextBuffer | 迁移源码与参考行为 |

## Latest Focus (2025-11-25)
- **Sprint 03 R36 – AA4 Search Review (#delta-2025-11-25-b3-textmodelsearch):** Restored `SearchPatternUtilities.IsMultilineRegexSource` inside `SearchTypes` to remove the dependency on `TextModelSearch`, deleted the duplicate helper in `TextModelSearch.cs`, and ported the remaining TS suites (`parseSearchRequest` invalid/literal/regex, `isMultilineRegexSource`, literal/`^line`/multiline/`line$` navigation). `tests/TextBuffer.Tests/TextModelSearchTests.cs` now includes the new helpers (`ExpectedSearchData`, `AssertParseSearchResult`) plus 10 additional facts; `TestMatrix.md` references the expanded coverage, and `dotnet test --filter TextModelSearchTests` reports 45/45 green (2.0s) for this drop.
- **Sprint 03 R36 – B3-TextModelSearch (#delta-2025-11-25-b3-textmodelsearch):** Realigned the Issue #53415 fixture with the TS tabbed line so `\W` spans tabs/blank lines exactly like VS Code, reran Issue-specific + TextModel/PieceTree search suites, and recorded the 2025-11-26 rerun evidence: `export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter TextModelSearchTests --nologo` → 45/45 (2.8s) plus the full `export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --nologo` → 365/365 (56.0s). TestMatrix/migration/sprint logs now mirror those numbers, and `agent-team/handoffs/B3-TextModelSearch-PORT.md` captures the delta.
- **Sprint 03 R30 – B3-TextModel-Snapshot (#delta-2025-11-25-b3-textmodel-snapshot):** Ported `TextModelSnapshot` so `TextModel.CreateSnapshot()` now wraps the raw PieceTree snapshot with the TS 64KB chunk aggregator, added `TextModelSnapshotTests` to guard chunk batching/EOS caching, refreshed `PieceTreeSnapshotTests`/`ParityTests`, and logged the targeted commands + evidence inside `tests/TextBuffer.Tests/TestMatrix.md` and `agent-team/handoffs/B3-TextModel-Snapshot-PORT.md`.
- **Sprint 03 R28 – B3-PieceTree-Snapshot (#delta-2025-11-25-b3-piecetree-snapshot):** Streamed `PieceTreeSnapshot.Read()` so BOM emits once and subsequent chunks follow TS order, exposed `TextModel.CreateSnapshot(bool preserveBom = false)` for higher-layer callers, and added the ASCII-only `SnapshotReader` helper to drain snapshots in a single pass. Legacy `PieceTreeSnapshotTests` now consume TextModel snapshots, and the TS `bug #45564` / `immutable snapshot 1/2/3` suites landed as `PieceTreeSnapshotParityTests`. Rerun evidence: `export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter PieceTreeSnapshotParityTests --nologo` (4/4, 1.7s) + the full `export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --nologo` (312/312, 58.7s). Docs updated: `TestMatrix.md` row + QA command, `docs/reports/migration-log.md` entry, Sprint R28 progress log, changefeed entry, and handoff `agent-team/handoffs/B3-PieceTree-Snapshot-PORT.md`.
- **Sprint 03 R29 – B3-PieceTree-Deterministic-CRLF (#delta-2025-11-25-b3-piecetree-deterministic-crlf):** Added `PieceTreeDeterministicScripts` helper data + 28 new deterministic Facts covering TS CRLF normalization bug battery and centralized line-start/chunk variants (ts lines 1054-1589). `PieceTreeDeterministicTests` now holds 50 Facts total; QA-Automation ran `dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter PieceTreeDeterministicTests --nologo` (50/50 green, 3.5s) plus the full sweep `dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --nologo` (308/308 green, 67.2s) on 2025-11-25, with TestMatrix/migration log evidence captured under `#delta-2025-11-25-b3-piecetree-deterministic-crlf` and archived in `agent-team/handoffs/B3-PieceTree-Deterministic-CRLF-QA.md`.
- **Sprint 03 R28 – B3-PieceTree-Deterministic (#delta-2025-11-24-b3-piecetree-deterministic):** Formalized the deterministic PieceTree suites by stamping MIT headers + TS attribution on the helper shims, wiring `PieceTreeDeterministicTests` into the TestMatrix, and publishing the dedicated changefeed/migration-log row. Validation command: `dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter PieceTreeDeterministicTests --nologo` (22/22 green, 13.4s in latest run).
- **Sprint 03 R27 – B3-PieceTree-Fuzz-Review follow-up (#delta-2025-11-24-b3-piecetree-fuzz):** Completed the Investigator CI-1/CI-2 asks by letting `PieceTreeFuzzHarness` seed from multi-chunk inputs (`PieceTreeBuffer.FromChunks`) while logging chunk counts in `FuzzLogCollector`, then ported TS `random test 1/2/3`, `random delete 1/2/3`, and both `random chunks` suites (ts/src/vs/editor/test/common/model/pieceTreeTextBuffer/pieceTreeTextBuffer.test.ts lines 271-404 & 1668-1725) using a deterministic script helper + TS-style `randomStr` generator. Chunk fuzzers run 1000/50 iterations against 5×1000 or 1×1000 seeds, call `AssertState()` per iteration (matching TS `testLinesContent`), and keep inserts/deletes in TS order. Docs refreshed: `tests/TextBuffer.Tests/TestMatrix.md` adds the CI-1/CI-2 rows and this memory/handoff file logs the delta. Validation: `cd /repos/PieceTreeSharp && export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter PieceTreeFuzzHarnessTests --nologo` → 10/10 green (52.5s).
- **Sprint 03 R26 – B3-PieceTree-Fuzz-Review (CI-2/W-1/W-2, placeholder #delta-2025-11-23-b3-piecetree-fuzz)**: Hardened `PieceTreeFuzzHarness.AssertState()` with TS `testLinesContent`/`testLineStarts` parity (per-line `GetLineContent`/`GetValueInRange` + offset round-trips and seeded log flush), brought `PieceTreeModel.GetLineContent()`/`PieceTreeBuffer.GetOffsetAt()` back in sync with TS semantics (no stray EOLs and CRLF-aware columns), verified sentinel metadata stays zero inside `PieceTreeModel.ValidateTreeInvariants()`, and matched the TS fuzz alphabet. Logged validation via `export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter PieceTreeFuzzHarnessTests --nologo`. CI-1 random suites + DOC-1 doc/test-matrix updates remain TODO for the follow-up drop.
- **Sprint 03 R25 – B3-Fuzz-Harness (#delta-2025-11-23-b3-piecetree-fuzz placeholder):** Delivered the reusable `PieceTreeFuzzHarness` (env-seeded RNG, range diff snapshots, `GetValueInRange` helper) plus structured `FuzzLogCollector` entries, tightened `PieceTreeModel.AssertPieceIntegrity()` with TS `assertTreeInvariants` parity, and added harness smoke tests (`PieceTreeFuzzHarnessTests`). Docs updated (`TestMatrix`, migration log, plan handoff) and logged validation via `dotnet test --filter PieceTreeFuzzHarnessTests` and `export PIECETREE_DEBUG=0 && dotnet test ... --nologo`.
- **Sprint 03 R21 – B3-FM-PrimarySelection (#delta-2025-11-24-find-primary):** Reworked `FindModel.SetSelections` so the first incoming range is always cloned + marked primary (defaulting to `(1,1)` when empty), removed the unused `_selectionCollection/_primarySelectionIndex`, and ensured `SelectAllMatches()` yields matches beginning at that primary cursor. `TestEditorContext.SetSelections/GetSelections` now mirrors VS Code semantics (first entry = active) and the new regression `DocUIFindModelTests.Test49_SelectAllMatchesRespectsPrimarySelectionOrder` guards select-all ordering. Documentation touchpoints: `tests/TextBuffer.Tests/TestMatrix.md` DocUI row, `docs/reports/migration-log.md` entry “2025-11-24 – B3-FM-PrimarySelection”, changefeed `agent-team/indexes/README.md#delta-2025-11-24-find-primary`, plus handoff `agent-team/handoffs/AA4-FindModel-Review-PORT.md`. Validation reran `export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter FullyQualifiedName~FindModelTests --nologo` (49/49 green) before logging the migration.
- **Sprint 03 R21 – B3-FM-MultiSelection (#delta-2025-11-24-b3-fm-multisel):** `FindModel` now clones editor multi-selections, tracks the primary cursor index, and reorders `SelectAllMatches()` so the active cursor stays at index 0. `TestEditorContext.SetSelections/GetSelections` gained TS-style multi-cursor plumbing, letting `DocUIFindModelTests.Test07/08` run end-to-end for overlapping + disjoint scopes. Logged the targeted filters (`--filter "FullyQualifiedName=PieceTree.TextBuffer.Tests.DocUI.FindModelTests.Test07_MultiSelectionFindModelNextStaysInScopeOverlap|FullyQualifiedName=PieceTree.TextBuffer.Tests.DocUI.FindModelTests.Test08_MultiSelectionFindModelNextStaysInScope"` and `--filter "FullyQualifiedName~FindModelTests"`) plus the full-suite run (242/242). Legacy alias `FullyQualifiedName~DocUIFindModelTests` is now retired. Authored `agent-team/handoffs/B3-FM-MultiSelection-PORT.md`, updated Sprint R21 + migration log, and queued Info-Indexer/DocMaintainer follow-ups once the changefeed post is live.
- **B3 DocUI staged fixes (#delta-2025-11-24-b3-docui-staged):** Patched `FindDecorations.Reset()` so `_startPosition` survives `IsFlush` edits and tightened `IntervalTree.CollectOverlaps()` (zero-length query ranges now behave like TS point-in-range checks). Added DocUI regressions `Test48_FlushEditKeepsFindNextProgress` and `CollapsedCaretAtMatchStartReturnsIndex` plus refreshed `TestMatrix.md` documentation. QA reran `export PIECETREE_DEBUG=0 && dotnet test ... --filter FullyQualifiedName~FindModelTests --nologo` (46/46) and `--filter FullyQualifiedName~DocUIFindDecorationsTests --nologo` (9/9); DocUIFindModel alias coverage is now fully migrated to the `FindModelTests` filter.
- **Sprint 03 R15 – B3-FC-MultilineSeed (#delta-2025-11-23-b3-fc-multiline-seed):** DocUI find controller now tracks whether selection seeds should be regex-normalized so SelectionSeedMode.Multiple (Cmd+E/Ctrl+Shift+L) keeps literal text, while SelectionSeedMode.Single still escapes. Added `StartFindWithSelection keeps literal parentheses when regex enabled` regression plus helper plumbing so Next/PreviousSelectionMatch reuse the new flag. Targeted `dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter DocUIFindControllerTests` (27/27 green) and logged the change for Investigator's Investigator finding #1 follow-up.
- **Sprint 03 R15 – B3-FC-Scope (#delta-2025-11-23-b3-fc-scope):** Patched `DocUIFindController` so `BuildSearchScope()` only overwrites `_state.SearchScope` when it returns a non-null range and ensured `NextSelectionMatchFindAction()` always reveals the widget + retries `MoveToNextMatch()`. Added `SearchScopePersistsWhenSelectionCollapses` and `NextSelectionMatchOnWhitespaceRevealsWidget` regressions plus TestMatrix/migration/changefeed updates.
- **Sprint 03 R15 – B3-FC-Lifecycle (#delta-2025-11-23-b3-fc-lifecycle):** Find widget lifecycle + seeding polish: `StartFindAction` now reseeds from the latest selection whenever host option ≠ Never, `StartFindReplaceAction` respects the `SeedSearchStringMode.Never` guard (no selection/global clipboard seed), `_model` is lazily created + disposed when the widget hides (clearing match info), replace panel re-hides when reopening via Ctrl+F, and `StartFindWithSelectionAction` gained TS issue #47400/#109756 coverage (multi-line Cmd+E + caret-word seed). Docs/TestMatrix/migration log updated with new targeted commands (DocUIFindControllerTests 26/26, DocUIFindSelectionTests 4/4, full suite 217/217).
- **Sprint 03 R18 – B3-Decor-Stickiness-Review (#delta-2025-11-23-b3-decor-stickiness-review):** Followed Investigator review (CI-1/CI-2/CI-3 + W-1/W-2) by removing `_cachedFindScopes`, preserving scope trailing newlines, wiring overview throttling to host viewport height, and allocating decoration owner IDs per controller. `DocUIFindDecorationsTests` gained newline/edit-tracking/viewport throttling cases, `TestEditorContext`/`DocUIFindController` now pipe viewport providers, and TestMatrix baseline rises to 235/235 with targeted `--filter DocUIFindDecorationsTests` 9/9 + `--filter DecorationStickinessTests` 4/4.
- **Sprint 03 R12 – B3-FM (#delta-2025-11-23-b3-fm):** `FindModel.SelectAllMatches()` 现实现 TS 多光标语义，按范围排序 matches 并保留主光标，新增 `DocUIFindModelTests.Test28/Test29` 覆盖 `selectAllMatches` + issue #14143 案例。
- **Sprint 03 R13 – B3-FSel (#delta-2025-11-23-b3-fsel):** 创建 `FindUtilities` + `IEditorSelectionContext`，实现 `GetSelectionSearchString`/`GetWordAtPosition` 并在 `DocUIFindSelectionTests` 复刻 TS `find.test.ts` 三套场景（光标词、单行选区、多行选区 null），为即将落地的 FindController seed 逻辑铺路。
- **Sprint 03 R14 – B3-FC-Core (#delta-2025-11-23-b3-fc-core):** 落地 `DocUIFindController`（Start/Replace/NextSelection/FindWithSelection 等命令）、`FindControllerHostOptions`、Storage/Clipboard stubs 以及 `DocUIFindControllerTests` 覆盖 issue #1857/#3090/#6149/#41027/#9043 + scope auto-update (#27083/#58604) 与 `NextSelectionMatch`（issue #38232）场景，完成 host/test harness（`TestEditorHost`、`TestFindControllerStorage`、`TestFindControllerClipboard`）。
- **Sprint 03 R15 – OI-013/OI-014/OI-015 DocUI polish (#delta-2025-11-24-find-parity):** 注入 host wordSeparators provider 到 `DocUIFindController`→`FindModel`→`FindReplaceState`，让 whole-word 搜索/seed 复用 Unicode classifier；新增 PreserveCase toggle 默认 + storage 持久化路径，Find widget 读 global clipboard 前先判空，`TestEditorContextOptions` 支持自定义分隔符。
- **Signals:**
  - `export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter FullyQualifiedName~DocUIFind --nologo` → 39/39 绿色（DocUI Find controller/model/selection + 新增 DocUIFindDecorations 套件；历史记录中的 17/17 仅适用于 2025-11-23 之前的 drop）。
  - `export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --nologo` → 204/204 绿色（最新全量基线）。文档：`TestMatrix.md`、`docs/sprints/sprint-03.md`、`docs/reports/migration-log.md`、`agent-team/handoffs/B3-FC-Result.md` 与 `agent-team/indexes/README.md` 已同步 `#delta-2025-11-24-find-parity`。
- **Next:** R15（B3-FC-Scope）需补充 FindController 搜索范围生命周期 / 多选区视觉反馈、Mac 专属全局剪贴板（富文本）和 searchScope 重新进入策略；R16 继续推进 Decorations stickiness / DocUI overlay capture。Batch #3 完成顺序：B3-FC-Scope → B3-Decor-Stickiness，并将 OI-014（WordSeparator parity）挂到 R15 之后。

## Worklog
- **2025-11-26 – DocReview Sync (#delta-2025-11-25-b3-textmodelsearch)**
  - Processed Investigator findings in `agent-team/handoffs/DocReview-20251126-INV.md`, acknowledged the stale 35/35 ↔ 355/355 references, and refreshed this memory entry with the 2025-11-26 rerun data (`--filter TextModelSearchTests` 45/45 @ 2.8s, full `dotnet test` 365/365 @ 56.0s, both under `PIECETREE_DEBUG=0`).
  - Logged the documentation fix + evidence summary in `agent-team/handoffs/DocFix-20251126-Porter.md` so DocMaintainer/Info-Indexer can trace the update back to the Investigator audit; no extra test executions were required beyond the cited rerun.
- **2025-11-25 – TextModelSearch Documentation Refresh (#delta-2025-11-25-b3-textmodelsearch)**
  - Re-reviewed the Investigator brief/diffs to capture the actual scope (SearchPatternUtilities helper + full TS 45-test suite) and reran `export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter FullyQualifiedName~TextModelSearchTests --nologo` (45/45, 2.0s) for fresh evidence.
  - Rewrote `agent-team/handoffs/B3-TextModelSearch-PORT.md` so it now describes the helper refactor, the imported TS buckets, the latest verification log, and the follow-up asks (doc/changefeed refresh + Intl.Segmenter backlog).
- **2025-11-25 – AA4 Search Review (#delta-2025-11-25-b3-textmodelsearch)**
  - Recreated `isMultilineRegexSource` inside `SearchTypes` (new `SearchPatternUtilities` helper) so `SearchParams.ParseSearchRequest()` no longer depends on `TextModelSearch`; removed the redundant helper from `TextModelSearch.cs`.
  - Ported the remaining TS suites into `TextModelSearchTests.cs`: parseSearchRequest invalid/non-regex/regex matrices, `isMultilineRegexSource` pattern sets, and the literal/`^line`/multiline/`line$` navigation regressions. Added helper scaffolding (`ExpectedSearchData`, `AssertParseSearchResult`, `DefaultRegexOptions`).
  - Updated `tests/TextBuffer.Tests/TestMatrix.md` TextModelSearch row + targeted rerun entry and reran `export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter TextModelSearchTests --nologo` (45/45 green, 2.0s) to document the expanded coverage.
- **2025-11-25 – B3-PieceTree-SearchOffset-PORT (#delta-2025-11-25-b3-search-offset)**
  - Authored `agent-team/handoffs/B3-PieceTree-SearchOffset-PORT.md` to document the landed deterministic scripts/tests (`PieceTreeSearchOffsetCacheTests.cs`, `PieceTreeDeterministicScripts`) per the investigator memo, capturing scope, helper coverage, and downstream dependencies.
  - Ran the targeted verification `export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter PieceTreeSearchOffsetCacheTests --nologo` (5/5, 1.6s) and recorded the command/result for QA + Info-Indexer follow-ups.
  - Next actions delegated: QA to rerun targeted + full suites before publishing the `#delta-2025-11-25-b3-search-offset` changefeed; Info-Indexer/DocMaintainer to update TestMatrix/migration-log/changefeed references once QA evidence lands.
- **2025-11-25 – B3-TextModelSearch (#delta-2025-11-25-b3-textmodelsearch)**
  - Synced `tests/TextBuffer.Tests/TextModelSearchTests.cs` Issue #53415 strings with TS (`"\tJust"` line) so `\W` matches consume the same tab + newline spans, removing the mislabeled `"Just\t"` variant that skewed expected columns.
  - Captured verification commands under `PIECETREE_DEBUG=0`: Issue fact (1/1, 1.9s), `--filter TextModelSearchTests` (45/45, 2.8s), `--filter PieceTreeSearchTests` (11/11, 1.7s), `--filter PieceTreeSearchOffsetCacheTests` (5/5, 1.8s), and the full `dotnet test` sweep (365/365, 56.0s).
  - Authored `agent-team/handoffs/B3-TextModelSearch-PORT.md`, refreshed `tests/TextBuffer.Tests/TestMatrix.md`, `docs/reports/migration-log.md`, `docs/sprints/sprint-03.md`, and this memory entry with the new changefeed reference pending Info-Indexer broadcast.
- **2025-11-25 – B3-TextModel-Snapshot (#delta-2025-11-25-b3-textmodel-snapshot)**
  - Ported `TextModelSnapshot` from TS `textModel.ts` Lines 72-115 so every `TextModel.CreateSnapshot()` wraps the raw `PieceTreeSnapshot` with the 64KB chunk aggregator. The wrapper caches EOS, skips zero-length chunks, and minimizes allocations when only a single chunk is produced.
  - Updated `TextModel.CreateSnapshot(bool preserveBom)` to instantiate the wrapper and added `TextModelSnapshotTests` (fake snapshot harness) to cover chunk aggregation, wrapper identity, empty-chunk skipping, and repeated-EOF behavior. The legacy `PieceTreeSnapshotTests`/`PieceTreeSnapshotParityTests` suites were rerun to confirm no regressions.
  - Documentation + evidence: `tests/TextBuffer.Tests/TestMatrix.md` now lists the new suite and targeted reruns, and `agent-team/handoffs/B3-TextModel-Snapshot-PORT.md` captures the code summary + commands.
  - Validation (PIECETREE_DEBUG=0): `dotnet test --filter TextModelSnapshotTests --nologo` (4/4, 2.5s), `--filter PieceTreeSnapshotTests --nologo` (2/2, 1.8s), `--filter PieceTreeSnapshotParityTests --nologo` (4/4, 1.7s).
- **2025-11-25 – B3-PieceTree-Snapshot (#delta-2025-11-25-b3-piecetree-snapshot)**
  - Refactored `PieceTreeSnapshot.Read()` to keep an internal `_index` that emits any BOM once (index 0) and then streams each piece slice sequentially, returning `null` only after all pieces and BOM have been consumed. This matches TS snapshot semantics and fixes prior duplicate chunk reads in tests.
  - Exposed `TextModel.CreateSnapshot(bool preserveBom = false)` so callers/tests no longer poke at `PieceTreeModel`. Added `tests/TextBuffer.Tests/Helpers/SnapshotReader.cs` to drain snapshots in a single pass with a chunk guard; rewrote `PieceTreeSnapshotTests` to use TextModel snapshots + cached content before draining.
  - Ported TS deterministics (`bug #45564`, `immutable snapshot 1/2/3`) into `PieceTreeSnapshotParityTests` and documented the suite in `tests/TextBuffer.Tests/TestMatrix.md` along with QA rerun instructions. Added migration-log entry, Sprint R28 progress log, changefeed (`agent-team/indexes/README.md#delta-2025-11-25-b3-piecetree-snapshot`), and new handoff `agent-team/handoffs/B3-PieceTree-Snapshot-PORT.md`.
  - Validation commands captured for QA parity: `export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter PieceTreeSnapshotParityTests --nologo` (4/4, 1.7s) and the full `export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --nologo` (312/312, 58.7s). Evidence is linked from the TestMatrix and handoff files; this entry keeps Porter memory in sync.
- **2025-11-25 – B3-PieceTree-Deterministic-CRLF (#delta-2025-11-25-b3-piecetree-deterministic-crlf)**
  - Introduced `PieceTreeDeterministicScripts` to capture TS script sequences for the CRLF random bug battery and centralized line-start/chunk suites (ts lines 1054-1589) so `PieceTreeDeterministicTests` could replay them verbatim; total deterministic Facts now 50 (previously 22).
  - Added harness helpers (`CreateCrlfHarness`, `CreateHarnessFromChunks`, `AssertFinalText`) plus CRLF delete regressions, 10 CRLF random bug tests, 10 centralized random bug tests, and 4 centralized random chunk tests. QA-Automation captured the rerun evidence on 2025-11-25 by executing `dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter PieceTreeDeterministicTests --nologo` (50/50, 3.5s) followed by the full sweep (308/308, 67.2s), and we recorded the outputs in `tests/TextBuffer.Tests/TestMatrix.md`, `docs/reports/migration-log.md`, and `agent-team/handoffs/B3-PieceTree-Deterministic-CRLF-QA.md`.
  - Logged the changefeed entry `agent-team/indexes/README.md#delta-2025-11-25-b3-piecetree-deterministic-crlf` plus the QA handoff so Info-Indexer can point to the completed reruns; Porter focused on code/tests/handoff work while QA executed the commands, so no local rerun was needed on the porter workstation.
- **2025-11-25 – Memory Sync**
  - Updated this memory entry to reflect the completed R29 QA evidence (`B3-PieceTree-Deterministic-CRLF-QA.md`, TestMatrix, migration log) per Porter-CS protocol.
- **2025-11-24 – B3-PieceTree-Deterministic (#delta-2025-11-24-b3-piecetree-deterministic)**
  - Added the standard MIT header + TS attribution to `PieceTreeBufferAssertions`, `PieceTreeScript`, and `PieceTreeDeterministicTests`, mirroring DocUI test style so helper files comply with Info-Indexer audit rules.
  - Published the deterministic suites changefeed/migration-log entry, refreshed `tests/TextBuffer.Tests/TestMatrix.md` row + targeted rerun table to reference the new anchor, and documented the rerun command for QA (22/22 facts).
  - Command logged: `dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter PieceTreeDeterministicTests --nologo` (22/22, ~13s). No code behavior changes beyond headers/docs.
- **2025-11-24 – B3-TestFailures parity (#delta-2025-11-24-b3-getlinecontent, #delta-2025-11-24-b3-sentinel)**
  - Updated `PieceTreeBaseTests.GetLineContent_Cache_Invalidation_*` and `PieceTreeNormalizationTests` to assert trimmed `GetLineContent` output while verifying raw terminators via `GetLineRawContent`, matching TS `splitLines`. Documented the shift in `tests/TextBuffer.Tests/TestMatrix.md` (new delta entry + targeted rerun logs).
  - Refactored `PieceTreeNode`/`PieceTreeModel` so each model owns its sentinel via `PieceTreeNode.CreateSentinel()`, eliminating the shared static sentinel that let fuzz tests trip `ValidateTreeInvariants` under xUnit parallelism. Updated `agent-team/type-mapping.md` to note the per-model sentinel contract and recorded the fuzz harness targeted rerun in the TestMatrix.
  - Validation: `export PIECETREE_DEBUG=0 && dotnet test -v m` (253/253, 54.5s) plus targeted commands for the cache invalidation pair, normalization suite, and `PieceTreeFuzzHarnessTests.RandomDeleteThreeMatchesTsScript`.
- **2025-11-24 – B3-PieceTree-Fuzz-Review follow-up (#delta-2025-11-24-b3-piecetree-fuzz)**
  - Added multi-chunk seeding support to `PieceTreeFuzzHarness` (constructor now accepts `IEnumerable<string>` + normalize flag, builds `_expected` from concatenated seed, logs chunk count via `FuzzLogCollector`).
  - Authored deterministic script helper + TS `randomStr` generator inside `PieceTreeFuzzHarnessTests`, then ported TS `random test 1/2/3`, `random delete 1/2/3`, and `random chunks`/`random chunks 2` suites (ts/src/vs/editor/test/common/model/pieceTreeTextBuffer/pieceTreeTextBuffer.test.ts lines 271-404, 1668-1725). Chunk suites now seed 5×1000 or 1×1000 chunks, run 1000/50 iterations (0.6 insert bias), and assert state each loop.
  - Updated `tests/TextBuffer.Tests/TestMatrix.md` with CI-1/CI-2 coverage rows + delta pointer, appended the handoff entry w/ validation log, and captured the rerun command below for QA attach.
  - Validation: `cd /repos/PieceTreeSharp && export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter PieceTreeFuzzHarnessTests --nologo` (10/10, 52.5s, harness-only run; summary included in handoff + TestMatrix).
- **2025-11-24 – B3-PieceTree-Fuzz-Review (CI-2/W-1/W-2 parity)**
  - Extended `PieceTreeFuzzHarness.AssertState()` with TS `testLinesContent`/`testLineStarts` parity checks (per-line `GetLineContent`, trimmed `GetValueInRange`, and `GetPositionAt`⇄`GetOffsetAt` validation) plus deterministic failure logging helpers (`SplitLines`, `ComputeLineStarts`, `TrimLineFeed`, `FailState`).
  - Updated `PieceTreeModel.ValidateTreeInvariants()` to enforce zeroed sentinel metadata, fixed `PieceTreeModel.GetLineContent()`/`PieceTreeBuffer.GetOffsetAt()` to mirror TS trimming + CRLF column semantics, and aligned `CreateRandomText()` with the TS alphabet so future fuzz runs share the same distribution; documented the delta + CI-1/DOC-1 TODOs in `agent-team/handoffs/B3-PieceTree-Fuzz-Review-PORT.md`.
  - Validation: `export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter PieceTreeFuzzHarnessTests --nologo` (pass).
- **2025-11-24 – B3-Fuzz-Harness (R25 placeholder #delta-2025-11-23-b3-piecetree-fuzz)**
  - Implemented `PieceTreeFuzzHarness` with env-driven seeds (`PIECETREE_FUZZ_SEED`, default `8675309`), deterministic RNG, per-iteration assertions, and reusable range diff helper `PieceTreeRangeDiff`. Harness exposes insertion/deletion/replace helpers plus light `GetValueInRange`/line-count APIs for deterministic suites.
  - Extended `FuzzLogCollector` with structured `FuzzOperationLogEntry` (operation name, offset, length, sanitized text, iteration, seed) so QA captures reproducible sequences; added smoke tests (`PieceTreeFuzzHarnessTests`) proving deterministic runs + corruption detection.
  - Strengthened `PieceTreeModel.AssertPieceIntegrity()` to mirror TS `assertTreeInvariants`: root/sentinel colors, parent/child wiring, red-node checks, black-height equality, and metadata validation (`SizeLeft`, `LineFeedsLeft`, `AggregatedLength/LineFeeds`).
  - Docs: new handoff `agent-team/handoffs/B3-PieceTree-Fuzz-Harness.md`, updated `tests/TextBuffer.Tests/TestMatrix.md` + `docs/reports/migration-log.md` (placeholder delta), referencing plan entry `B3-PieceTree-Fuzz-PLAN`.
  - Validation: `dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter PieceTreeFuzzHarnessTests --nologo` (2/2) and `export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --nologo` (245/245, ~4.1s).
- **2025-11-24 – B3-FM MultiSelection (#delta-2025-11-24-b3-fm-multisel)**
  - Completed the multi-selection porter run kicked off by Investigator R20: `FindModel` now clones the incoming selection set, keeps `_currentSelection` aligned with the (first) primary range, reorders `SelectAllMatches()` so the active cursor remains first, and updates `_decorations` start positions whenever multi-cursor state changes.
  - `TestEditorContext.SetSelections()` treats the first selection as primary (matching VS Code), clones ranges before handing them to `FindModel`, and exposes `GetSelections()` for scope snapshots so TS Test07/08 can hydrate overlapping/disjoint scopes exactly once.
  - Re-enabled `DocUIFindModelTests.Test07/Test08` and confirmed the harness keeps matches within the provided scopes. Logged the targeted reruns with the actual type name (`export PIECETREE_DEBUG=0 && dotnet test ... --filter "FullyQualifiedName=PieceTree.TextBuffer.Tests.DocUI.FindModelTests.Test07_MultiSelectionFindModelNextStaysInScopeOverlap|FullyQualifiedName=PieceTree.TextBuffer.Tests.DocUI.FindModelTests.Test08_MultiSelectionFindModelNextStaysInScope" --nologo`, 2/2) plus the suite-wide filter (`--filter "FullyQualifiedName~FindModelTests" --nologo`, 48/48). Full suite `export PIECETREE_DEBUG=0 && dotnet test ... --nologo` passed 242/242; the DocUI alias has been removed from rerun docs.
  - Authored `agent-team/handoffs/B3-FM-MultiSelection-PORT.md`, added the Sprint R21 log entry, and appended a migration-log row so Info-Indexer can broadcast `#delta-2025-11-24-b3-fm-multisel` alongside the warning about the deprecated filter alias.
- **2025-11-24 – B3 DocUI staged fixes (#delta-2025-11-24-b3-docui-staged)**
  - Implemented Investigator CI fixes: kept `_startPosition` intact during `FindDecorations.Reset()` and added zero-length range handling inside `IntervalTree.CollectOverlaps()` so caret selections intersect find decorations just like TS interval tree logic (ts/src/vs/editor/common/model/intervalTree.ts L240-260).
  - Added DocUI regression tests `DocUIFindModelTests.Test48_FlushEditKeepsFindNextProgress` (flush edit should not reset `MatchesPosition`) and `DocUIFindDecorationsTests.CollapsedCaretAtMatchStartReturnsIndex` (caret-overlap guard), updated `tests/TextBuffer.Tests/TestMatrix.md`, and documented the drop in `agent-team/handoffs/B3-DocUI-StagedFixes-20251124.md`.
  - Validation (run via QA-Automation per protocol):
    - `export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter FullyQualifiedName~FindModelTests --nologo` → 46/46 green (DocUI FindModel suite, includes Test48 and prior scope regressions).
    - `export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter FullyQualifiedName~DocUIFindDecorationsTests --nologo` → 9/9 green (DocUI decorations suite, includes collapsed caret guard).
    - Note: legacy alias `FullyQualifiedName~DocUIFindModelTests` has been retired (it always yielded 0/0 because the compiled type is `PieceTree.TextBuffer.Tests.DocUI.FindModelTests`).
- **2025-11-24 – B3-FM scope tracking & normalization fix (#delta-2025-11-24-find-scope)**
  - Implemented pending search-scope overrides plus decoration-first scope resolution in `FindModel`, ensuring new `_state.SearchScope` ranges are applied exactly once before rehydrating from `_decorations.GetFindScopes()`. Reintroduced TS `_normalizeFindScopes` semantics so multi-line scopes snap to full lines (issue #27083 parity).
  - Added `Test45_SearchScopeTracksEditsAfterTyping` and `Test46_MultilineScopeIsNormalizedToFullLines` under `DocUIFindModelTests`, updated `TestMatrix.md`, migration log, changefeed, and published `agent-team/handoffs/AA4-Review-Porter.md` for AA4 reviewer follow-up.
  - Validation: `export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter FullyQualifiedName~FindModelTests --nologo` (44/44 green); note that the historical `DocUIFindModelTests` alias has been retired after confirming it always returned 0/0.
- **2025-11-23 – Sprint 03 R15 (B3-FC regex selection seeding parity)**
  - Refactored `DocUIFindController` seed plumbing so `TrySeedSearchString` carries a `shouldNormalize` flag; only `SelectionSeedMode.Single` escapes when regex is enabled, while `SelectionSeedMode.Multiple` (Cmd+E / StartFindWithSelection) now pipes literal multi-line text through. `Next/PreviousSelectionMatch` helpers flow the new flag, keeping their regex coverage intact.
  - Added `StartFindWithSelection keeps literal parentheses when regex enabled` to `DocUIFindControllerTests`, documenting Investigator #1 repro (`foo(bar)` stays unescaped in regex mode) alongside the existing multi-line seeding regressions.
  - Validation: `dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter DocUIFindControllerTests` (27/27).
- **2025-11-23 – Sprint 03 R15 (B3-FC fallback scope & Alt+Enter parity)**
  - Updated `DocUIFindController.Start` to compute AutoFindInSelection scopes internally (so Next/Prev fallback starts pick them up) while persisting only non-empty ranges, and added `PreviousMatchFindAction`, `PreviousSelectionMatchFindAction`, plus `SelectAllMatchesAction` to surface `_model.SelectAllMatches()` through the host.
  - Extended `DocUIFindControllerTests` with `AutoFindInSelectionAppliesDuringFallbackStart`, backward navigation parity cases (`Issue3090_PreviousMatchLoopsWithinSingleLine`, `Issue38232_PreviousSelectionMatchRegex`), and Alt+Enter coverage (`SelectAllMatchesActionAppliesSelections`, `SelectAllMatchesActionReturnsFalseWhenNoMatches`); updated `tests/TextBuffer.Tests/TestMatrix.md` DocUI row accordingly.
  - Validation: `dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter DocUIFindControllerTests` (20/20) and full `dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj` (211/211).
- **2025-11-23 – Sprint 03 R15 (B3-FC-Scope W1/W2)**
  - Updated `DocUIFindController.Start` so `BuildSearchScope()` only overwrites `_state.SearchScope` when a non-null scope is produced, preserving find-in-selection ranges when the caret collapses. Tweaked `NextSelectionMatchFindAction()` to always call `Start(...)` after a failed `MoveToNextMatch()` (even without a seed) and retry, matching TS Ctrl/Cmd+F3 semantics.
  - Added `DocUIFindControllerTests.SearchScopePersistsWhenSelectionCollapses` + `NextSelectionMatchOnWhitespaceRevealsWidget`, refreshed `TestMatrix.md` (DocUI row + targeted rerun 15/15), noted closure in `migration-log.md`, `agent-team/indexes/README.md#delta-2025-11-23-b3-fc-scope`, `B3-FC-Review.md`, and this memory file.
  - Validation: `export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter DocUIFindControllerTests --nologo` (15/15). Changefeed + docs tagged `#delta-2025-11-23-b3-fc-scope` for Info-Indexer.
- **2025-11-23 – Sprint 03 R15 (B3-FC-Lifecycle/Seeding)**
  - Refined `DocUIFindController`: StartFind reseeds whenever host prefers selection (`SeedSearchStringMode != Never`), StartFindReplace honors the `Never` preference (skip selection + global clipboard), `_model` now lazy-initializes and disposes (clearing match counts) when the widget hides, and replace UI collapses if the widget was previously hidden. Added Cmd+E regressions (`issue #47400` multi-line, `issue #109756` caret word), Ctrl+F reseed regression, StartFindReplace “Never” guard test, and lifecycle test capturing match-count clearing.
  - Updated docs (`TestMatrix.md`, `docs/plans/ts-test-alignment.md`, `docs/reports/migration-log.md`) with `#delta-2025-11-23-b3-fc-lifecycle`, bumped DocUI targeted rerun counts (DocUIFindControllerTests 26/26, DocUIFindSelectionTests 4/4) and total suite (217/217). Pending changefeed entry to broadcast the new delta.
  - Validation: `dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter DocUIFindControllerTests --nologo` (26/26), `--filter DocUIFindSelectionTests` (4/4), full `dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --nologo` (217/217).
- **2025-11-24 – Sprint 03 R15 (OI-013/OI-014/OI-015 DocUI polish)**
  - 将 host wordSeparators provider 贯穿 `DocUIFindController` → `FindModel` → `FindReplaceState` 并复用 `WordCharacterClassifierCache`，`FindUtilities` 现能根据 Unicode 分词器正确获取 hyphen/emoji 边界。
  - 增加 PreserveCase toggle 默认值与 storage key，Find widget 新增 `TogglePreserveCase()` 流程；`FindModel` 构造注入 host 选项，`FindReplaceState.CreateSearchParams()` 使用 provide separators。
  - `DocUIFindController` 在读取全局剪贴板时若 `string.IsNullOrEmpty` 则 no-op，避免空字符串覆盖查找文本；`DocUIFindControllerTests` 添加默认值/持久化/空剪贴板覆盖，`DocUIFindSelectionTests` + `DocUIFindModelTests` 追加自定义分隔符断言。
  - Tests：`export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter FullyQualifiedName~DocUIFind --nologo`（39/39，自 DocUIFindDecorations 登陆后更新的期望值）+ `export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --nologo`（204/204）。
  - 文档：更新 `tests/TextBuffer.Tests/TestMatrix.md`（新增 Test44 + hyphen regression + controller OI-013/OI-015 注记，总数 204），同步本 Worklog/Latest Focus，准备 `#delta-2025-11-24-find-parity` 撰写。
- **2025-11-19**
  - 完成首轮 Onboarding，熟悉 AI Team 运作方式、Sprint 目标与 PT-004 期待成果。
  - 审核当前 C# 骨架，确认 `PieceTreeBuffer` 仍为占位，需从 Core 目录启动红黑树实现。
  - 记录代码/测试日志归档位置（`src/TextBuffer/README.md`）。
- **2025-11-19 – Org Self-Improvement Mtg**
  - 评估 C# 端缺口（仅余 `ChunkBuffer`/`PieceSegment` + `StringBuilder` 缓冲），确认 PT-004 首阶段需先落 `PieceTreeNode`/sentinel/Tree 容器。
  - 与 Planner/Investigator/QA/DocMaintainer 对齐依赖：获取 Builder/Search/PrefixSum 类型映射、runSubAgent 模板拆分、QA 属性测试入口及 Porting Log 写入约定。
  - 承诺交付 Core README + TreeDebug 钩子帮助 QA 复核不变量，并把结构性变更写入 Porting Log。
- **2025-11-19 – PT-004.M2 drop**
  - 将 `PieceTreeBuffer` 接上 `ChunkBuffer` → `PieceTreeBuilder` → `PieceTreeModel` 流水线，`FromChunks`/`Length`/`GetText`/`ApplyEdit` 均以 PieceTree 数据驱动。
  - `ChunkBuffer` 新增 line-start/CRLF 计算与 `Slice` helper，`PieceSegment.Empty`、builder result 等保证 sentinel 元数据，`ApplyEdit` 暂以“重建整棵树”作为 TODO 记录的降级方案。
  - Tests: `dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj`（pass，4 tests：multi-chunk builder + CRLF edit 覆盖）。
  - Risks: 每次编辑仍需重建树（性能/暂时性），Search stub 依旧待 Investigator-TS 完善类型映射后再规划 PT-007。
- **2025-11-19 – PT-004 literal translation spike**
  - 在 `src/TextBuffer/PortingDrafts/PieceTreeBase.literal.cs.txt` 新建 Literal C# 版本，完成 TypeScript `pieceTreeBase.ts` 开头到搜索逻辑的 1:1 结构移植并标注剩余 TODO，供后续增量补全与 Info-Indexer 建立 PortingDrafts 钩子。

- **2025-11-19 – PT-004 line infra/cache drop**
  - 按类型映射要求实现 `LineStartTable`/`LineStartBuilder`（`src/TextBuffer/Core/LineStarts.cs`）并让 `ChunkBuffer` 保存 CR/LF/CRLF 计数与 `IsBasicAscii` 标志，PieceTreeBuilder 重用该元数据。
  - 新增 `PieceTreeSearchCache`（`src/TextBuffer/Core/PieceTreeSearchCache.cs`）及 `PieceTreeModel` 缓存钩子，后续 `nodeAt`/`getLineContent` 可复用缓存且在插入时自动失效。
  - Tests: `dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj`（pass，7 tests）。
- **2025-11-19 – PT-004 positions/API drop**
  - 增加 `TextPosition` 结构与 `PieceTreeBuffer` 的 `GetPositionAt` / `GetOffsetAt` / `GetLineLength` / `GetLineCharCode` / `GetCharCode` API，暂以全文快照+`LineStartBuilder` 计算坐标，后续将替换为 tree-aware 实现。
  - 在 `tests/TextBuffer.Tests/UnitTest1.cs` 移植 TS `prefix sum` 风格断言，覆盖 offset→position round trip、CRLF 行长与行内字符编码，测试总数扩展至 10。
  - Tests: `dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj`（pass，10 tests）。

- **2025-11-19 – PT-004 insert/delete drop**
  - 实现 `PieceTreeModel.Edit.cs`，包含 `Insert`、`Delete`、`RbDelete`、`DeleteFixup` 等核心红黑树编辑逻辑，替换了之前的重建树方案。
  - `PieceTreeNode` 增加 `Next()`、`Detach()` 及属性 setter 以支持树操作。
  - `PieceTreeBuffer.ApplyEdit` 更新为调用 `_model.Delete` 和 `_model.Insert`。
  - 移植 TS 基础编辑测试至 `PieceTreeBaseTests.cs`，覆盖 `BasicInsertDelete`、`MoreInserts`、`MoreDeletes`。
  - Tests: `dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj`（pass，13 tests）。

- **2025-11-19 – PT-005 Search**
  - 实现 `PieceTreeSearcher` (C# Regex wrapper) 与 `SearchTypes` (SearchData, FindMatch, Range)。
  - 实现 `PieceTreeModel.Search.cs`，包含 `FindMatchesLineByLine`、`FindMatchesInNode`、`FindMatchesInLine` 等核心搜索逻辑。
  - 移植 TS 搜索逻辑，包括多行搜索、简单字符串搜索优化、Regex 搜索。
  - 新增 `PieceTreeSearchTests.cs`，覆盖基本字符串搜索、Regex 搜索、多行搜索。
  - Tests: `dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj` (pass, 16 tests)。

- **2025-11-19 – PT-008 Snapshot**
  - 创建 `ITextSnapshot` 接口与 `PieceTreeSnapshot` 实现，支持基于 `PieceTreeModel` 的不可变快照读取。
  - 更新 `PieceTreeModel` 以暴露 `Buffers` 并提供 `CreateSnapshot` 方法。
  - 新增 `PieceTreeSnapshotTests.cs`，覆盖快照读取与不可变性验证（即使 Model 变更，Snapshot 内容保持不变）。
  - Tests: `dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj` (pass, 18 tests)。

- **2025-11-19 – PT-009 Line Optimization**
  - 在 `PieceTreeModel.cs` 中引入 `LastVisitedLine` 结构与 `_lastVisitedLine` 字段，实现单行缓存。
  - 更新 `PieceTreeModel.Search.cs` 中的 `GetLineContent` 以利用缓存，并在 `PieceTreeModel.Edit.cs` 的 `Insert`/`Delete` 中失效缓存。
  - 在 `PieceTreeBuffer` 中暴露 `GetLineContent` 以供测试。
  - 新增 `PieceTreeBaseTests.cs` 测试用例 `GetLineContent_Cache_Invalidation_Insert` 和 `GetLineContent_Cache_Invalidation_Delete`，验证缓存失效逻辑。
  - Tests: `dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj` (pass, 20 tests)。
- **2025-11-20 – AA3-004 CL2 Search Fixes**
  - 将 `SearchTypes.ParseSearchRequest` 切换为 `RegexOptions.ECMAScript` 并添加 Unicode wildcard 改写辅助，`PieceTreeSearcher` 也确保 Regex 处于 ECMAScript 模式。
  - 收紧 `WordCharacterClassifier`（仅接受配置的符号 + SPACE/TAB/CR/LF），恢复 TS word-boundary 行为并避免 NBSP/EN SPACE 误判。
  - 新增 AA3 审计覆盖：`\bcaf\b` 边界、ASCII-only digits、Unicode 分隔符、emoji 量词、多选区 regex；记录于 `PieceTreeSearchTests.cs` 与 `TextModelSearchTests.cs`。
  - 文档：创建 `agent-team/handoffs/AA3-004-Result.md`，更新 `docs/reports/migration-log.md` 与 `agent-team/indexes/README.md#delta-2025-11-20`。
  - Tests: `dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj`（84/84）。

- **2025-11-20 – AA3-008 Decorations/DocUI**
  - 复刻 TS decoration 存储：引入 `DecorationsTrees`（regular/overview/injected）与共享 `DecorationRangeUpdater` stickiness 逻辑，`TextModel` 现可查询字体/注入文本/边距装饰并在 `OnDidChangeDecorations` 事件中输出 minimap/overview/glyph/line号/行高/字体元数据。
  - 升级 `MarkdownRenderer` 与选项结构，支持多 owner filter、z-index 排序、注入文本 markers、glyph/margin/overview/minimap 注记，DocUI 行尾附带注解标签。
  - Tests：在 `DecorationTests` 添加 metadata round-trip & 事件断言，在 `MarkdownRendererTests` 覆盖 owner filter 列表、注入文本、glyph/minimap 注解；`dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj`（85/85）。
  - 文档：创建 `agent-team/handoffs/AA3-008-Result.md`，更新 Task Board / Sprint / AGENTS / Migration Log / Changefeed。

- **Upcoming Goals (runSubAgent 粒度):**
  1. **PT-005.Search**：实现 `PieceTreeSearch` 逻辑，支持 Find/Match 等操作。
  2. **PT-004.G3**：实现长度/位置互转与 chunk-based slicing 的额外断言，扩充 xUnit 覆盖（CR-only、BOM、跨 chunk ranges）。
  3. **OI-SUPPORT.G1**：保持 Porting Log & Core README 更新，并将 search stub 依赖、doc 钩子同步给 DocMaintainer/Planner 以支撑 PT-007 规划。

## Blocking Issues
- 仍需 Investigator-TS 在 `agent-team/type-mapping.md` 中补充 `pieceTreeTextBufferBuilder.ts` / `textModelSearch.ts` / `prefixSumComputer.ts` 字段与缓存语义，避免盲目迁移。
- QA-Automation 尚未锁定属性测试/基准入口，需其在 PT-005 定稿后提供最小断言集合以验证我们暴露的 API。
- DocMaintainer 的迁移日志模板（PT-006）与 Main Agent 的“是否 1:1 复刻 TS 红黑树” 决策待定，此前实现需保持开关便于回滚配置。

## Active AA4-006 Worklog
- **2025-11-21 09:00 UTC**: Start work on AA4-006 (CL6) addressing change buffer append heuristics, AverageBufferSize chunk creation, CRLF repair logic across chunks, and SearchCache invalidation precision. Implemented candidate heuristics and tests; next step refine CRLF handling across chunk boundaries.
- **2025-11-21 16:30 UTC**: Begin AA4-006 Fix1 Plan (Porter-CS): reproducing failing tests `TestSplitCRLF` and `CRLF_RepairAcrossChunks`; will add debug helpers and iterate on fixes (Update: added debug printing and first reproduction run).
- **2025-11-21 23:55 UTC**: AA4-006 wrap-up – finished chunk-append fix + change-buffer reuse tracking (`_lastChangeBufferPos/_lastChangeBufferOffset`), tightened search cache range invalidations, exposed `PieceTreeModel.AssertPieceIntegrity`, and ported deterministic CRLF fuzz logging via `FuzzLogCollector`. Updated `PieceTreeModelTests`, `CRLFFuzzTests`, `TestMatrix`, `migration-log`, `task-board`, and this memory doc with the final CL6 handoff.
## End of Worklog (2025-11-21)
- **2025-11-21 15:40 UTC**: Completed porting `ChangeBuffer` append optimization (`_lastChangeBufferPos` tracking + append to `_buffers[0]`), AverageBufferSize splitting using `ChunkUtilities.SplitText`, and targeted SearchCache invalidation updating. Added unit tests for Append optimization, chunk splitting and SearchCache validation. Ran `dotnet test` and recorded results.
 - **2025-11-21 18:00 UTC**: Started AA4-007 (CL7) – cursor word/snippet/multi-select parity. Plan: implement `CursorCollection`/`CursorState`/`CursorContext`, `WordCharacterClassifier` + `WordOperations`, `CursorColumns`, `SnippetSession`/`SnippetController`, update `MarkdownRenderer` doc output; add tests and remediations.
 - **2025-11-21 22:30 UTC**: Completed AA4-007 implementation prototype: added `CursorCollection`, `CursorState`, `CursorContext`, `WordCharacterClassifier`, `WordOperations`, `CursorColumns`, `SnippetSession`, and `SnippetController`. Implemented `Cursor` word methods, integrated `CursorCollection` into the model via `CreateCursorCollection()`, and added unit tests: `CursorMultiSelectionTests`, `CursorWordOperationsTests`, `ColumnSelectionTests`, `SnippetControllerTests`, and updated `MarkdownRendererTests` with `TestRender_MultiCursorAndSnippet`. Ran `dotnet test` and all `PieceTree.TextBuffer` tests passed (113/113). See `agent-team/handoffs/AA4-007-Result.md` for details.
- **2025-11-21 23:20 UTC**: Reviewed Investigator AA4-008 (CL8 DocUI overlays) addendum; cataloged F1–F4 remediation surfaces, align degrade heuristics (>1k matches), capture metadata plumbing, and doc/changefeed obligations ahead of execution planning.
- **Follow-ups**:
  - Carry AA4-007 cursor/snippet work forward using the new metadata invariants (multi-cursor edits near CR/LF boundaries).
  - AA4-008 DocUI/search overlay work should reuse the deterministic CRLF fuzz harness + `AssertPieceIntegrity` to guard owner-specific decorations.
- **Blockers**:
  - `FixCRLF` behavior interacts with `ChunkUtilities` splitting technique such that initial insertion of `\r\n` as a change-buffer piece or change buffer append clobbers boundaries; need to carefully unify chunk splitting & CRLF rejoin logic. 
  - Due to time constraints, CRLF fixes require further coordinated test coverage and a detailed review vs TS `pieceTreeTextBufferBase` logic.

- **2025-11-22 – Sprint 02 Phase 7 (AA4) Alignment**
  - Synced with Investigator-TS + QA-Automation on TS test inventory (`TestMatrix.md`) and the new plan at `docs/plans/ts-test-alignment.md`; Batch #1 target is `replacePattern.test.ts` parity plus DocUI harness prep.
  - Action items: draft DocUI `replacePattern` execution plan (deliverable/test/dependency map), capture WordSeparator + DocUI selection helper gaps, note harness scaffolding requirements, and ensure outputs flow into migration log, changefeed, TestMatrix, and plan checkpoints.
  - New directive (AA4 Batch #1 – ReplacePattern): before implementation deliver a checklist covering touched files (`ReplacePattern.cs`, DocUI controllers, fixtures, harness JSON/tests), API surface synopsis, migration-log entry template (include QA commands & DocUI snapshots), and risk/dependency plan (WordSeparator cache, harness substitutes). Output must reference Planner checkpoints and broadcast feed `#delta-2025-11-22` once artifacts land.
 - **2025-11-22 – Batch #1 ReplacePattern Kickoff**
   - Began scoping C# runtime drop for `ReplacePattern` (port TS `replacePattern.ts` helpers + `ReplacePatternResult`/`ReplacePatternRequest` types) and lined up DocUI harness needs (`DocUITestHost`, `DocUIReplacePatternTests`, `DocUIReplacePatternFixtures`).
  - TODO next session: map TS `replacePattern.test.ts` cases to `tests/TextBuffer.Tests/ReplacePatternTests.cs`, stub runtime entry in `src/TextBuffer/Core/ReplacePattern.cs`, scaffold DocUI harness under `tests/TextBuffer.Tests/DocUI/` with test JSON ingestion, update `docs/plans/ts-test-alignment.md#Batch-1` checkpoints.
   - Dependencies/blockers: need Investigator-TS to confirm WordSeparator + regex expansion semantics, confirm DocUI harness telemetry path, ensure `DocUIHarness.json` sample assets merge cleanly with `ts/test/` snapshots.
- **2025-11-22 – Batch #1 ReplacePattern Plan Update**
  - Captured deliverable breakdown for runtime skeleton (`ReplacePattern.cs`), DocUI controller, and tests, plus doc/report touchpoints (AA4-008 result + migration log) ahead of implementation.
  - Logged evidence plan (`dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj`, DocUI capture artifacts) and reiterated outstanding blockers (fixture export pipeline, WordSeparator spec from Investigator-TS).
  - Ready to drop initial code diffs + documentation updates once green-lit; this entry reflects current memory sync per Porter-CS instructions.
- **2025-11-22 – Batch #1 ReplacePattern Skeleton Draft (Porter-CS)**
  - Re-read Batch #1 directives; prepping concrete runtime/controller/test skeletons so editors can wire up parity quickly.
  - Tracking follow-up doc work for `agent-team/handoffs/AA4-008-Result.md` and `docs/reports/migration-log.md` to run immediately after the first ReplacePattern chunk lands.
  - Blockers: awaiting fixture JSON export from DocUITestHost + Investigator guidance on WordSeparator spec so case-preserve helpers stay aligned with TS `search.ts`.

- **2025-11-22 – PT-007 Source Attribution (Batch 1: Core)**
  - 完成 **Batch 1: Core (PieceTree Base)** 的 11 个文件的 TypeScript 源文件溯源注释标注任务。
  - 处理的文件：
    - `ChunkBuffer.cs` → `pieceTreeBase.ts` (Lines: 27-98, createLineStarts functions)
    - `ChunkUtilities.cs` → `pieceTreeBase.ts` (Text chunking utilities)
    - `ITextSnapshot.cs` → `model.ts` (ITextSnapshot interface)
    - `LineStarts.cs` → `pieceTreeBase.ts` (Lines: 27-98, LineStarts class)
    - `PieceSegment.cs` → `pieceTreeBase.ts` (Piece interface, BufferCursor type)
    - `PieceTreeBuilder.cs` → `pieceTreeTextBufferBuilder.ts` (Lines: 67-188)
    - `PieceTreeDebug.cs` → N/A (Original C# implementation)
    - `PieceTreeModel.cs` → `pieceTreeBase.ts` (Lines: 268-1882, PieceTreeBase class)
    - `PieceTreeModel.Edit.cs` → `pieceTreeBase.ts` (Lines: 800-1500, Insert/Delete operations)
    - `PieceTreeModel.Search.cs` → `pieceTreeBase.ts` (Lines: 1500-1800, Search operations)
    - `PieceTreeNode.cs` → `rbTreeBase.ts` (Lines: 8-425, TreeNode class)
  - 更新了 `docs/tasks/source-attribution-progress.md`，将 Batch 1 所有文件状态更新为 Complete，总进度从 0% 提升至 12.5% (11/88)。
  - 特殊情况：`PieceTreeDebug.cs` 标记为 C# 原创实现（环境变量控制的调试日志工具）。

- **2025-11-22 – PT-007 Source Attribution (Batch 2: Core Support Types)**
  - 完成 **Batch 2: Core Support Types** 的 8 个文件的 TypeScript 源文件溯源注释标注任务。
  - 处理的文件：
    - `PieceTreeSearchCache.cs` → `pieceTreeBase.ts` (Lines: 100-268, PieceTreeSearchCache class)
    - `PieceTreeSearcher.cs` → `pieceTreeBase.ts` (Lines: 1500-1700, Searcher implementation)

- **2025-11-22 – B1-PORTER ReplacePattern Implementation (Batch #1 Complete)**
  - **实现文件**:
    - `src/TextBuffer/Core/ReplacePattern.cs`: 完整移植 TS replacePattern.ts 的核心逻辑
      - `ReplacePattern` 类：支持静态值和动态片段两种模式
      - `ReplacePiece` 类：表示替换片段（静态文本或捕获组引用）
      - `ReplacePatternParser.ParseReplaceString()`: 解析替换字符串，支持 `$1`, `$&`, `$$`, `\n`, `\t`, `\\`, `\u`, `\U`, `\l`, `\L` 等模式
      - `BuildReplaceStringWithCasePreserved()`: 实现大小写保持逻辑（支持连字符、下划线分隔的单词）
    - `src/TextBuffer/Rendering/DocUIReplaceController.cs`: DocUI 替换控制器
      - `Replace()`: 单次替换操作
      - `ReplaceAll()`: 批量替换操作
      - `ExecuteReplace()`: 执行替换并应用到 TextModel（预留 TODO 供 Batch #2）
      - `DocUIReplaceHelper.QuickReplace()`: 测试辅助方法
  - **测试文件**:
    - `tests/TextBuffer.Tests/ReplacePatternTests.cs`: 23 个测试用例
      - 基础解析测试：无转义、Tab、换行、转义反斜杠、尾部反斜杠、未知转义
      - 捕获组测试：`$0`, `$1-$9`, `$10-$99`, `$$`, `$&`
      - 大小写修饰符测试：`\u`, `\U`, `\l`, `\L`
      - JavaScript 语义测试：隐式捕获组、捕获组语义
      - 完整匹配测试：基础替换、Import 示例、其他案例
      - 子串匹配测试：基础、前瞻断言
      - Issue #19740: 未定义捕获组处理
      - 大小写保持测试：基础、连字符、下划线、集成测试
  - **测试结果**:
    - ✅ 全量测试通过：142/142（新增 23 个 ReplacePattern 测试）
    - 命令：`dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj`
  - **已知差异**:
    - C# Regex 和 JavaScript Regex 的捕获组语义存在细微差异（已在测试注释中标注）
    - 空捕获组 `()` 在 C# 中返回空字符串 `""`，JavaScript 可能有不同行为（已调整测试期望）
  - **TODO 标记**（供 Batch #2）:
    - `DocUIReplaceController.ExecuteReplace()`: 集成到 TextModel 的编辑操作和装饰更新
    - `// TODO(B2): Integrate with FindModel state for incremental replace`
    - `// TODO(B2): Add WordSeparator context for word boundary support`
  - **文档更新**:
    - 源文件溯源注释已添加到 `ReplacePattern.cs` 和 `DocUIReplaceController.cs`
    - TypeScript 源：`ts/src/vs/editor/contrib/find/browser/replacePattern.ts` (Lines: 1-340)
    - TypeScript 源：`ts/src/vs/base/common/search.ts` (Lines: 8-50)
  - **下一步建议**:
    - QA-Automation 可添加更多边界测试（emoji、Unicode、超大捕获组编号）
    - Investigator-TS 需确认 WordSeparator 语义以支持 `$w` 占位符（如 TS 支持）
    - DocMaintainer 需更新 migration-log.md 记录此次 ReplacePattern 移植
    - Batch #2 需实现 FindModel 集成以支持增量替换和装饰更新
    - `PieceTreeSnapshot.cs` → `pieceTreeTextBuffer.ts` (Lines: 50-150, ITextSnapshot)
    - `PieceTreeTextBufferFactory.cs` → `pieceTreeTextBufferBuilder.ts` (Lines: 190-350, Factory)
    - `Range.Extensions.cs` → `range.ts` (Lines: 50-150, IRange extensions)
    - `SearchTypes.cs` → `textModelSearch.ts` + `wordCharacterClassifier.ts` (multi-source)
    - `Selection.cs` → `selection.ts` (Lines: 1-100, Selection class)
    - `TextMetadataScanner.cs` → `pieceTreeBase.ts` (Lines: 100-150, RTL/line terminator detection)
  - 更新了 `docs/tasks/source-attribution-progress.md`，将 Batch 2 所有文件状态更新为 Complete，总进度从 12.5% 提升至 21.6% (19/88)。
  - 特殊情况：`SearchTypes.cs` 合并了多个 TS 源文件（textModelSearch.ts 和 wordCharacterClassifier.ts）。

- **2025-11-22 – PT-007 Source Attribution (Batch 3: Cursor)**
  - 完成 **Batch 3: Cursor** 的 9 个文件的 TypeScript 源文件溯源注释标注任务。
  - 处理的文件：
    - `Cursor.cs` → `oneCursor.ts` (Lines: 15-200, Cursor class)
    - `CursorCollection.cs` → `cursorCollection.ts` (Lines: 15-250, CursorCollection class)
    - `CursorColumns.cs` → `cursorColumnSelection.ts` (Lines: 10-50, visible column calculations)
    - `CursorContext.cs` → `cursorContext.ts` (Lines: 10-23, CursorContext class)
    - `CursorState.cs` → `cursorCommon.ts` (Lines: 271-340, CursorState/SingleCursorState)
    - `SnippetController.cs` → `snippet/browser/snippetController2.ts` (Lines: 30-500)
    - `SnippetSession.cs` → `snippet/browser/snippetSession.ts` (Lines: 30-600)
    - `WordCharacterClassifier.cs` → `core/wordCharacterClassifier.ts` (Lines: 20-150)
    - `WordOperations.cs` → `cursor/cursorWordOperations.ts` (Lines: 50-800)
  - 更新了 `docs/tasks/source-attribution-progress.md`，将 Batch 3 所有文件状态更新为 Complete，总进度从 21.6% 提升至 31.8% (28/88)。
  - 涉及的 TS 源文件分布在多个目录：common/cursor/, contrib/snippet/browser/, common/core/。

- **2025-11-22 – PT-007 Source Attribution (Batch 4: Decorations)**
  - 完成 **Batch 4: Decorations** 的 6 个文件的 TypeScript 源文件溯源注释标注任务。
  - 处理的文件：
    - `DecorationChange.cs` → `model/textModel.ts` (Decoration change tracking structures)
    - `DecorationOwnerIds.cs` → `model/textModel.ts` (Owner ID constants)
    - `DecorationRangeUpdater.cs` → `model/intervalTree.ts` (Lines: 410-510, nodeAcceptEdit + adjustMarkerBeforeColumn)
    - `DecorationsTrees.cs` → N/A (Original C# implementation - multi-tree structure)
    - `IntervalTree.cs` → `model/intervalTree.ts` (Lines: 142-1100, IntervalTree + IntervalNode)
    - `ModelDecoration.cs` → `model.ts` (Multi-source: TrackedRangeStickiness, IModelDecoration, IModelDecorationOptions, etc.)
  - 更新了 `docs/tasks/source-attribution-progress.md`，将 Batch 4 所有文件状态更新为 Complete，总进度从 31.8% 提升至 38.6% (34/88)。
  - 特殊情况：
    - `DecorationsTrees.cs` 标记为原创 C# 实现（VS Code 使用单一 IntervalTree，C# 版本将装饰分为 regular/overview/injected 三棵树以优化性能）
    - `ModelDecoration.cs` 合并了 `model.ts` 中的多个接口和枚举定义（TrackedRangeStickiness、IModelDecoration、各种装饰选项接口等）

- **2025-11-22 – PT-007 Source Attribution (Batch 5: Diff Algorithms - Part 1)**
  - 完成 **Batch 5: Diff Algorithms - Part 1** 的 8 个文件的 TypeScript 源文件溯源注释标注任务。
  - 处理的文件：
    - `Diff/Algorithms/DiffAlgorithm.cs` → `algorithms/diffAlgorithm.ts` (Base algorithm interfaces, timeout implementations)
    - `Diff/Algorithms/DynamicProgrammingDiffing.cs` → `algorithms/dynamicProgrammingDiffing.ts` (Lines: 10-150)
    - `Diff/Algorithms/MyersDiffAlgorithm.cs` → `algorithms/myersDiffAlgorithm.ts` (Lines: 15-200)
    - `Diff/Array2D.cs` → `algorithms/diffAlgorithm.ts` (Lines: 200-230, 2D array utility)
    - `Diff/ComputeMovedLines.cs` → `computeMovedLines.ts` (Lines: 20-800, move detection)
    - `Diff/DiffComputer.cs` → `defaultLinesDiffComputer.ts` (Lines: 30-600)
    - `Diff/DiffComputerOptions.cs` → Multi-source: `defaultLinesDiffComputer.ts` + `linesDiffComputer.ts`
    - `Diff/DiffMove.cs` → `linesDiffComputer.ts` (Lines: 50-80, MovedText interface)
  - 更新了 `docs/tasks/source-attribution-progress.md`，将 Batch 5 Part 1 的 8 个文件状态更新为 Complete，总进度从 38.6% 提升至 47.7% (42/88)。
  - 备注：这批文件主要来自 VS Code 的 diff 算法实现，包括 Myers 和动态规划两种核心算法，以及移动块检测逻辑。

- **2025-11-22 – PT-007 Source Attribution (Batch 6: Diff Algorithms - Part 2)**
  - 完成 **Batch 6: Diff Algorithms - Part 2** 的 8 个文件的 TypeScript 源文件溯源注释标注任务。
  - 处理的文件：
    - `Diff/DiffResult.cs` → `linesDiffComputer.ts` (Lines: 19-37, LinesDiff class)
    - `Diff/HeuristicSequenceOptimizations.cs` → `heuristicSequenceOptimizations.ts` (Lines: 12-473, multiple optimization functions)
    - `Diff/LineRange.cs` → `rangeMapping.ts` (Lines: 1-18) + C# LineRangeSet extension
    - `Diff/LineRangeFragment.cs` → `utils.ts` (Lines: 30-74, LineRangeFragment class)
    - `Diff/LineSequence.cs` → `lineSequence.ts` (Lines: 10-45, LineSequence class)
    - `Diff/LinesSliceCharSequence.cs` → `linesSliceCharSequence.ts` (Lines: 14-246, LinesSliceCharSequence class)
    - `Diff/OffsetRange.cs` → `rangeMapping.ts` (Lines: 76-107, OffsetRange class)
    - `Diff/RangeMapping.cs` → `rangeMapping.ts` (Lines: 19-395, RangeMapping + LineRangeMapping + DetailedLineRangeMapping)
  - 更新了 `docs/tasks/source-attribution-progress.md`，将 Batch 6 所有文件状态更新为 Complete，总进度从 47.7% 提升至 56.8% (50/88)。
  - 特殊情况：
    - `LineRange.cs` 包含了 TS 中的 LineRange 类以及 C# 特有的 LineRangeSet 实现（用于高效的范围集合操作）
    - `RangeMapping.cs` 合并了 rangeMapping.ts 中的多个类（RangeMapping、LineRangeMapping、DetailedLineRangeMapping）及辅助函数
    - 整个 Diff 模块（16 个文件）现已全部完成溯源标注

- **2025-11-23 – B3-FC-Core (R14)**
  - 构建 `DocUIFindController`（Start/FindReplace/FindWithSelection/NextMatch/NextSelection/Replace/ReplaceAll/Toggle*），实现 focus + clipboard + storage 管线，并在 `TestEditorHost` 暴露 selections/edits/clipboard 模拟，使 controller 不依赖 VS Code runtime。新增 `TestFindControllerStorage`、`TestFindControllerClipboard` stub，复用 `FindUtilities` selection seed 逻辑。
  - `DocUIFindControllerTests.cs` 复刻 TS `findController.test.ts` 核心场景：issue #1857（F3 reuse typed text）、#3090（单行循环）、#6149（regex seed auto-escape）、#41027（保持输入框内容）、#9043（隐藏 widget 清空 scope）、#27083/#58604（自动 scope 更新/空选区不更新）、#38232（NextSelectionMatch regex，无/有 widget）。
  - 测试：`export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter DocUIFindControllerTests --nologo`（10/10）+ 全量 `dotnet test ... --nologo`（199/199）。输出 `agent-team/handoffs/B3-FC-Result.md`、更新 `TestMatrix`/`Sprint 03`/`Migration Log`/`Indexes` 并广播 `#delta-2025-11-23-b3-fc-core`。
 - **2025-11-23 – Sprint 03 R16 (B3-Decor stickiness & DocUI overlays)**
   - `FindDecorations` 带上 range highlight 裁剪、overview throttling（>1000 matches 合并）、minimap/overview 元数据、scope normalization 与彻底清理全部 decoration groups；`TextModel` 新增 `GetAllDecorations`/`GetLineDecorations`/`GetDecorationIdsByOwner` API 供 DocUI harness/MarkdownRenderer 直接查询。
   - `DecorationTests` 补 per-line 查询、owner 过滤、事件通知、编辑驱动更改断言；新增 `DecorationStickinessTests` 覆盖四种 stickiness 模式的起止插入矩阵（配合 `forceMoveMarkers` 覆写），`DocUIFindDecorationsTests` 验证 range highlight/overview/scope 缓存/导航行为。
   - 验证：`dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --nologo` 233/233；专项 `--filter DecorationStickinessTests`（4/4）与 `--filter DocUIFindDecorationsTests`（6/6）。文档：更新 `TestMatrix`、`docs/plans/ts-test-alignment.md`、`docs/sprints/sprint-03.md`、`docs/reports/migration-log.md`、`agent-team/handoffs/B3-Decor-PORTER.md`，等待 Info-Indexer 发布 `#delta-2025-11-23-b3-decor-stickiness`。
  - 已知待办（移交 R15/R16）：searchScope UI 生命周期（多选区 / reopen 行为）、Mac 全局查找剪贴板富文本同步、FindWidget focus state persistence 以及 Decorations stickiness capture。

- **2025-11-22 – B2-001 FindModel Stubs Creation (Batch #2 准备)**
  - 完成 **FindModel 基础设施（stubs）创建**，为 B2-002 核心逻辑实现铺路。
  - 新增文件：
    - `src/TextBuffer/DocUI/FindReplaceState.cs`: 管理 find/replace 状态，包含搜索参数、flags、匹配计数、事件通知
      - 实现 `CreateSearchParams()` 方法，将 state 转换为 `SearchParams`（集成 WholeWord 支持）
      - 包含 `Change()` 方法统一更新状态并触发事件
      - 实现 `ChangeMatchInfo()` 更新匹配计数和当前匹配
    - `src/TextBuffer/DocUI/FindDecorations.cs`: 管理 find match 装饰（高亮）
      - Stub 实现，预留 TODO(B2-002) 标记用于核心逻辑
      - 基础方法：`SetCurrentMatch()`, `SetAllMatches()`, `ClearDecorations()`, `GetAllMatchRanges()`
    - `src/TextBuffer/DocUI/FindModel.cs`: FindModel 核心类（空壳）
      - 构造函数接受 `TextModel` 和 `FindReplaceState`
      - 核心方法全部预置 TODO(B2-002) 标记：`FindNext()`, `FindPrevious()`, `Replace()`, `ReplaceAll()`, `SelectAllMatches()`
      - 辅助方法：`UpdateDecorations()`, `UpdateState()`（均为空壳）
    - `tests/TextBuffer.Tests/DocUI/DocUIFindModelTests.cs`: 验证测试（7 个测试，Stub 阶段）
      - `FindReplaceState_CreateSearchParams_CreatesValidParams`: 验证 SearchParams 创建（WholeWord=true）
      - `FindReplaceState_CreateSearchParams_WithoutWholeWord_NoWordSeparators`: 验证 WholeWord=false 时无 wordSeparators
      - `FindDecorations_InitialState_HasZeroDecorations`: 验证初始装饰数为 0
      - `FindModel_Construction_DoesNotThrow`: 验证 FindModel 构造不抛异常
      - `FindModel_Dispose_DoesNotThrow`: 验证 Dispose 双重调用不抛异常
      - `FindReplaceState_Change_FiresEvent`: 验证状态变更事件触发
      - `FindReplaceState_ChangeMatchInfo_UpdatesMatchCount`: 验证匹配计数更新事件
  - 测试结果：`dotnet test` 通过，总数 142 → 149（新增 7 个测试）
  - TODO 清单（供 B2-002）:
    - `FindDecorations`: 实现装饰创建、高亮切换、范围查询（依赖 TextModel decoration API）
    - `FindModel`: 实现 `FindNext/Prev()` 导航、`Replace/ReplaceAll()` 替换、`SelectAllMatches()` 多选、`UpdateDecorations()` 装饰更新、`UpdateState()` 状态同步
    - 集成 Batch #1 `ReplacePattern` 用于替换操作
    - 监听 `FindReplaceState.OnFindReplaceStateChange` 事件触发重新搜索
  - 下一步建议：
    - B2-002: 实现 `FindModel` 核心逻辑（search/replace/navigation）
    - B2-003: QA 添加完整测试套件（参考 B2-QA-Result.md 的 15 个测试场景）
    - 依赖：TextModel decoration API 需要暴露给 DocUI 层

- **2025-11-22 – PT-007 Source Attribution (Batch 7: Services & Top-level)**
  - 完成 **Batch 7: Services & Top-level** 的 11 个文件的 TypeScript 源文件溯源注释标注任务。
  - 处理的文件：
    - `EditStack.cs` → `model/editStack.ts` (Lines: 384-452, EditStack class)
    - `PieceTreeBuffer.cs` → `pieceTreeTextBuffer/pieceTreeTextBuffer.ts` (Lines: 33-630, PieceTreeTextBuffer class)
    - `Properties/AssemblyInfo.cs` → N/A (Original C# implementation - assembly metadata)
    - `SearchHighlightOptions.cs` → `model/textModelSearch.ts` (SearchParams interface)
    - `Services/ILanguageConfigurationService.cs` → `languages/languageConfigurationRegistry.ts` + C# simplified service
    - `Services/IUndoRedoService.cs` → `platform/undoRedo/common/undoRedo.ts` + C# in-process implementation
    - `TextModel.cs` → `model/textModel.ts` (Lines: 120-2688, TextModel class)
    - `TextModelDecorationsChangedEventArgs.cs` → `textModelEvents.ts` (IModelDecorationsChangedEvent)
    - `TextModelOptions.cs` → `model.ts` + `core/misc/textModelDefaults.ts` (multi-source)
    - `TextModelSearch.cs` → `model/textModelSearch.ts` (TextModelSearch + SearchParams)
    - `TextPosition.cs` → `core/position.ts` (Lines: 9-200+, IPosition + Position)
  - 更新了 `docs/tasks/source-attribution-progress.md`，将 Batch 7 所有文件状态更新为 Complete，总进度从 56.8% 提升至 69.3% (61/88)。
  - 特殊情况：
    - `Properties/AssemblyInfo.cs` 标记为原创 C# 实现（C# 程序集元数据配置）
    - `Services/ILanguageConfigurationService.cs` 和 `Services/IUndoRedoService.cs` 为混合移植：接口来自 TS，但包含 C# 特有的简化实现（无完整 DI 基础设施）
    - `TextModelOptions.cs` 合并了多个 TS 源（model.ts 中的枚举定义 + textModelDefaults.ts 中的配置选项）
    - 核心服务层和顶层 API 现已全部完成溯源标注

- **2025-11-22 – PT-007 Source Attribution (Batch 8: Core Tests)**
  - 完成 **Batch 8: Core Tests** 的 12 个测试文件的 TypeScript 源文件溯源注释标注任务。
  - 处理的文件：
    - `AA005Tests.cs` → N/A (Original C# implementation - AA-005 CRLF splitting validation tests)
    - `PieceTreeBaseTests.cs` → `test/common/model/pieceTreeTextBuffer/pieceTreeTextBuffer.test.ts` (Lines: 214-265, basic insert/delete tests)
    - `PieceTreeBuilderTests.cs` → `test/common/model/pieceTreeTextBuffer/pieceTreeTextBuffer.test.ts` (Lines: 1500+, builder chunk splitting/BOM/metadata tests)
    - `PieceTreeFactoryTests.cs` → `test/common/model/pieceTreeTextBuffer/pieceTreeTextBuffer.test.ts` (Lines: 100+, factory line text/EOL tests)
    - `PieceTreeModelTests.cs` → `test/common/model/pieceTreeTextBuffer/pieceTreeTextBuffer.test.ts` (change buffer optimization tests)
    - `PieceTreeNormalizationTests.cs` → `test/common/model/pieceTreeTextBuffer/pieceTreeTextBuffer.test.ts` (Lines: 1730+, delete CR in CRLF normalization)
    - `PieceTreeSearchTests.cs` → `test/common/model/textModelSearch.test.ts` (FindMatches literal/regex/multiline/word boundaries)
    - `PieceTreeSnapshotTests.cs` → `test/common/model/pieceTreeTextBuffer/pieceTreeTextBuffer.test.ts` (snapshot immutability tests)
    - `TextModelTests.cs` → `test/common/model/textModel.test.ts` (TextModel creation/selection/editing tests)
    - `TextModelSearchTests.cs` → `test/common/model/textModelSearch.test.ts` (multi-range search/findInSelection/wrapping)
    - `DecorationTests.cs` → `test/common/model/model.decorations.test.ts` (DeltaDecorations/owner scopes/stickiness)
    - `DiffTests.cs` → `test/common/diff/defaultLinesDiffComputer.test.ts` (word diff/ignore whitespace/move detection)
  - 更新了 `docs/tasks/source-attribution-progress.md`，将 Batch 8 所有文件状态更新为 Complete，总进度从 69.3% 提升至 83.0% (73/88)。
  - 特殊情况：
    - `AA005Tests.cs` 标记为原创 C# 实现（专门用于 AA-005 审计的 CRLF 分割验证测试）
    - 大部分测试文件来自同一个 TS 测试文件 `pieceTreeTextBuffer.test.ts`，但涵盖了不同的测试场景（行号范围不同）
    - 搜索、装饰、Diff 测试分别对应独立的 TS 测试文件

- **2025-11-22 – PT-007 Source Attribution (Batch 9: Feature Tests & Test Helpers) ✅ FINAL**
  - 完成 **Batch 9: Feature Tests & Test Helpers** 的最后 12 个文件的 TypeScript 源文件溯源注释标注任务。
  - 处理的文件：
    - `ColumnSelectionTests.cs` → `contrib/multicursor/test/browser/multicursor.test.ts` (Column selection and visible column calculations)
    - `CRLFFuzzTests.cs` → N/A (Original C# implementation - Fuzz testing for CRLF handling edge cases)
    - `CursorMultiSelectionTests.cs` → `contrib/multicursor/test/browser/multicursor.test.ts` (Multi-cursor editing and rendering)
    - `CursorTests.cs` → `test/common/controller/cursorAtomicMoveOperations.test.ts` (Basic cursor movement operations)
    - `CursorWordOperationsTests.cs` → `contrib/wordOperations/test/browser/wordOperations.test.ts` (Word movement and deletion)
    - `MarkdownRendererTests.cs` → N/A (Original C# implementation - Visual debugging output for editor state)
    - `SnippetControllerTests.cs` → `contrib/snippet/test/browser/snippetController2.test.ts` + `snippetSession.test.ts` (Snippet insertion, placeholder navigation)
    - `SnippetMultiCursorFuzzTests.cs` → N/A (Original C# implementation - Fuzz testing for snippet placeholders with multi-cursor)
    - `UnitTest1.cs` → `test/common/model/pieceTreeTextBuffer/pieceTreeTextBuffer.test.ts` (Core PieceTree buffer operations)
    - `Helpers/FuzzLogCollector.cs` → N/A (Original C# implementation - Fuzz test operation logger)
    - `Helpers/PieceTreeModelTestHelpers.cs` → N/A (Original C# implementation - Debug utilities for model inspection)
    - `PieceTreeTestHelpers.cs` → `test/common/model/pieceTreeTextBuffer/pieceTreeTextBuffer.test.ts` (Text reconstruction helper)
  - 更新了 `docs/tasks/source-attribution-progress.md`，将 Batch 9 所有文件状态更新为 Complete，总进度从 83.0% 提升至 **100.0% (88/88) ✅**。
  - **🎉 PT-007 Source Attribution Task COMPLETE!**
    - **Total Files:** 88/88 完成
    - **Direct TypeScript Ports:** ~70 files
    - **C# Specific Implementations:** ~18 files
    - **Completion Rate:** 100%
  - 特殊情况：
    - 4 个模糊测试文件标记为原创 C# 实现（CRLFFuzzTests、SnippetMultiCursorFuzzTests、FuzzLogCollector、PieceTreeModelTestHelpers）
    - 1 个 Markdown 渲染器测试文件标记为原创 C# 实现（MarkdownRendererTests - 用于可视化调试）
    - 其余测试文件均对应 VS Code 的 TypeScript 测试套件，涵盖 multicursor、cursor operations、word operations、snippet 等功能模块

- **2025-11-22 – B2-002 FindModel Core Logic Implementation ✅ COMPLETE**
  - **实现文件**:
    - `src/TextBuffer/DocUI/FindDecorations.cs`: 完整实现装饰管理
      - `Set()`: 批量创建/更新 find match 装饰，支持大结果集优化（>1000 matches 使用简化装饰）
      - `SetCurrentMatch()`: 高亮当前匹配，返回 1-based 位置
      - `ClearDecorations()` / `Reset()`: 清除装饰和重置状态
      - `GetCurrentMatchRange()` / `GetAllMatchRanges()`: 获取装饰范围
      - `GetCurrentMatchesPosition()`: 获取选区对应的匹配位置
      - `MatchBeforePosition()` / `MatchAfterPosition()`: 查找前/后匹配（支持 wrap-around）
      - 装饰选项：`CurrentFindMatchDecoration` (zIndex=13)、`FindMatchDecoration` (zIndex=10)、`FindMatchNoOverviewDecoration`、`FindScopeDecoration`
    - `src/TextBuffer/DocUI/FindModel.cs`: 核心逻辑实现
      - `Research()`: 执行搜索并更新装饰和状态
      - `FindNext()` / `FindPrevious()`: 导航到下一个/上一个匹配
      - `MoveToNextMatch()` / `MoveToPrevMatch()`: 内部导航逻辑
      - `SetCurrentFindMatch()`: 设置当前匹配并更新状态
      - `Replace()`: 单次替换，集成 ReplacePattern (Batch #1)
      - `ReplaceAll()`: 批量替换，倒序应用编辑避免位置偏移
      - `SelectAllMatches()`: 标记为 TODO(Batch #3)，需要 multi-cursor API
      - `GetReplacePattern()`: 根据 IsRegex 创建 ReplacePattern
      - `GetMatchesForReplace()`: 为替换获取 capture groups
      - 事件驱动：监听 `FindReplaceState.OnFindReplaceStateChange`，自动触发重新搜索
    - `src/TextBuffer/TextModel.cs`: 新增公共 API
      - `GetDecorationById()`: 根据 ID 获取装饰（用于 FindDecorations 访问装饰详情）
  - **测试文件**:
    - `tests/TextBuffer.Tests/DocUI/DocUIFindModelTests.cs`: 扩展为 16 个测试用例（接替早期 Stub 文件）
      - 基础测试（7 个）：State/Decorations/Construction/Dispose/Event
      - 搜索测试（2 个）：`BasicSearch_FindsMatches`、`SearchWithNoMatches_ReturnsZero`
      - 导航测试（1 个）：`FindNext_NavigatesToNextMatch`
      - 替换测试（2 个）：`Replace_ReplacesCurrentMatch`、`ReplaceAll_ReplacesAllMatches`
      - Regex测试（2 个）：`RegexSearch_FindsMatches`、`RegexReplace_WithCaptureGroups`
  - **测试结果**:
    - ✅ 全量测试通过：156/156（新增 9 个 FindModel 功能测试，总数 149 → 156）
    - 命令：`dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj`
  - **集成要点**:
    - ✅ 集成 Batch #1 `ReplacePattern`：支持静态替换、正则替换、capture groups、case-preserving
    - ✅ 装饰管理：使用 `TextModel.DeltaDecorations()` 创建/删除装饰，owner ID = 1000
    - ✅ 大结果集优化：>1000 matches 使用 `FindMatchNoOverviewDecoration`（无 overview ruler）
    - ✅ 位置计算：`TextModel.GetPositionAt()` / `GetOffsetAt()` 转换 TextRange ↔ Range
    - ✅ 编辑操作：`TextModel.PushEditOperations()` 应用替换，倒序处理避免位置偏移
  - **已知限制**:
    - ⚠️ `SelectAllMatches()` 标记为 TODO(Batch #3)，需要 TextModel 多光标 API（未实现）
    - ⚠️ 装饰颜色/主题：当前使用简化选项（无 OverviewRuler/Minimap 颜色），需要主题系统支持
    - ⚠️ Find in Selection：`FindReplaceState.SearchScope` 支持搜索范围限制，但 UI 层需要 Batch #3 实现
  - **下一步建议**:
    - B2-003 (QA): 添加 TS `findModel.test.ts` 对等测试（43 个用例），覆盖边缘情况（空匹配、正则边界符、lookahead regex 等）
    - Batch #3 (FindController): 实现命令层、快捷键绑定、Find Widget UI、多光标集成
    - 性能优化：考虑增量搜索（仅更新变更区域的匹配）、装饰虚拟化（大文件场景）
  - **文档更新**:
    - 源文件溯源注释已添加到所有实现文件
    - TypeScript 源：`ts/src/vs/editor/contrib/find/browser/findModel.ts` (Lines: 1-616)
    - TypeScript 源：`ts/src/vs/editor/contrib/find/browser/findDecorations.ts` (Lines: 1-349)

## Testing & Validation Plan
- 默认使用 `dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj` 进行单元测试，按 PT-004 每阶段至少补一个针对 Node/Tree API 的断言。必要时添加 BenchmarkDotNet 基准（待骨架稳定）。
- 关键红黑树操作需辅以调试断言（如节点颜色/黑高），计划构建 Debug-only 验证方法供 QA 复用。

## Hand-off Checklist
1. 所有代码位于 `src/TextBuffer` 并通过 `dotnet test`。
2. Tests or validations performed? 若本轮涉及实现，需提供结果。
3. 下一位接手者读取“Upcoming Goals”并续写实现，同时参考 `src/TextBuffer/README.md` Porting Log 获取代码/测试细节。
