# AA4 Audit Checklist – Alignment & Audit R4

Purpose: 为 Sprint 02 建立 CL5~CL8“发现 → 修复 → 验证”流水线，把 Investigator-TS 的差异分析与 Porter-CS/QA 的实现、测试分离记录，持续缩短主 Agent 上下文占用。

## Scope & Workflow
1. 每个清单条目（CL#）由 Investigator-TS 通过 `runSubAgent` 产出分析，写入本文档与 `agent-team/handoffs/AA4-00X-*.md`。
2. Porter-CS 按条目下“Proposed Fixes” 执行实现/测试，完成后更新 `docs/reports/migration-log.md`、`agent-team/indexes/README.md` changefeed 及 handoff。
3. QA-Automation 在“Validation Hooks” 区域登记新增/扩展测试，并在 run log 中附 `dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj` 结果。
4. Info-Indexer / DocMaintainer 在条目完成后同步 Sprint / Task Board / AGENTS，保持 changefeed 指针一致。

## Checklist Overview
| ID | Scope | Investigator Output | Porter Output | QA Hooks | Status | Links |
| --- | --- | --- | --- | --- | --- | --- |
| CL5 | PieceTree Builder & Factory parity（TS `pieceTreeTextBufferBuilder.ts`、`pieceTreeBase.ts` vs C# `PieceTreeBuilder`/`ChunkBuffer`/`LineStartBuilder`） | `agent-team/handoffs/AA4-001-Audit.md` | `agent-team/handoffs/AA4-005-Result.md` | `PieceTreeBuilderTests`、`PieceTreeFactoryTests`、`AA005Tests`（CRLF carryover） | QA: Failing (CRLF repair & GetLineRawContent) — Needs Porter-CS follow-up | [`AA4-001-Audit`](../../agent-team/handoffs/AA4-001-Audit.md) |
| CL6 | ChangeBuffer/CRLF/large edits（TS `_insert/_delete`逻辑、`_lastChangeBufferPos`、AverageBufferSize） vs `PieceTreeModel.Edit.cs` | `agent-team/handoffs/AA4-002-Audit.md` | `agent-team/handoffs/AA4-006-Result.md` | `PieceTreeModelTests`（change-buffer heuristics/metadata rebuild/CRLF fuzz）、`CRLFFuzzTests`（deterministic logging）、`PieceTreeBaseTests` | Porter+QA Verified：change buffer reuse solidified、metadata rebuild + `AssertPieceIntegrity`、deterministic CRLF fuzz harness logged in AA4-006 Result；AA4-009 rerun (2025-11-21) captured `export PIECETREE_DEBUG=0 && dotnet test ... --nologo` = 119/119 with fuzz logs redirected to `/tmp/aa4-009-fuzz-logs`. | [`AA4-002-Audit`](../../agent-team/handoffs/AA4-002-Audit.md) |
| CL7 | Cursor word/snippet/multi-selection semantics（TS `cursor*.ts`, `snippetController2.ts`） vs `src/TextBuffer/Cursor/*` | `agent-team/handoffs/AA4-003-Audit.md` | _TBD – Porter follow-up required_ | `CursorMultiSelectionTests` / `CursorWordOperationsTests` / `ColumnSelectionTests` / `SnippetControllerTests` / (Markdown renderer snapshot pending) | **Audit refreshed – High risk (F1–F6 open)** | [`AA4-003-Audit`](../../agent-team/handoffs/AA4-003-Audit.md) |
| CL8 | DocUI Find/Replace overlays + Decorations（TS `findController.ts`、`findDecorations.ts`、`findModel.ts`、`wordCharacterClassifier.ts`） vs DocUI stack/Markdown renderer | `agent-team/handoffs/AA4-004-Audit.md` | `agent-team/handoffs/AA4-008-Result.md` | `TextModelSearchTests`、`DocUIFind*Tests`、`MarkdownRendererTests`（owner filter + replace preview） | **Audit refreshed – High risk (F1–F4 open: Markdown renderer, capture metadata, Intl.Segmenter, WordSeparator perf)** | [`AA4-004-Audit`](../../agent-team/handoffs/AA4-004-Audit.md) |

## Detail Sections

### CL5 – PieceTree Builder & Factory
- **Investigator Notes:** 详见 `agent-team/handoffs/AA4-001-Audit.md`。关键缺口：chunk splitting/CRLF 修复（carryover + AverageBufferSize）、BOM 丢失、`containsRTL/containsUnusualLineTerminators/isBasicASCII` 未暴露、缺少 `PieceTreeTextBufferFactory`（含 `Create(defaultEOL)` / `GetFirstLineText`）、`DefaultEndOfLine` 选举与 Normalize-EOL 流程均偏离 TS。共列出 6 条 F1~F6（High×2、Medium×4）。
- **Proposed Fixes:** 增补 builder/factory 管线、在 `PieceTreeBuildResult` 保留 BOM+metadata、复刻 `_getEOL` 与 normalize window、将 chunk 分片 helper 复用至 `CreateNewPieces`。Porter 交付记录 `agent-team/handoffs/AA4-005-Result.md`。
- **Porter Status (2025-11-20):** `PieceTreeBuilder` 现通过 `ChunkUtilities.SplitText/NormalizeChunks` 分片，`PieceTreeTextBufferFactory` 负责 BOM/EOL/metadata 输出，`PieceTreeBuffer` 缓存 builder 选项并在 `PieceTreeModel.Insert` 中复用新 helper。新增 `PieceTreeBuilderTests`（chunk + BOM + CR carryover）、`PieceTreeFactoryTests`（preview/EOL heuristics）、`PieceTreeTestHelpers` 以及扩展的 `AA005Tests`（CRLF 修复）。
- **Validation Hooks:** `PieceTreeBuilderTests`, `PieceTreeFactoryTests`, `AA005Tests` 均纳入 `dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj`（95/95）。QA-AA4-009 需在回归中扩展 builder/metadata fuzz cases后再行收口。 

### CL6 – ChangeBuffer / CRLF / Large Edits
- **Investigator Notes:** 详见 `agent-team/handoffs/AA4-002-Audit.md`。F1~F6 覆盖 change buffer append heuristics 缺失、 `_lastChangeBufferPos` 状态缺口、CRLF repair stub、`AverageBufferSize` 拆 chunk缺失、`GetLineFeedCnt` metadata 偏差与 SearchCache 粒度失配。
- **Proposed Fixes:** 恢复 change buffer 语义（复用 buffer0、跟踪 `_lastChangeBufferPos`）、完整移植 TS CRLF/linefeed 逻辑、实现 chunk splitting + metadata recompute + cache validate（`ComputeBufferMetadata`）。
- **Validation Hooks:** `PieceTreeBaseTests`（change buffer fuzz）、`PieceTreeNormalizationTests`（CRLF insert/delete）、`PieceTreeBuilderTests`/`PieceTreeSearchTests`（AverageBufferSize + cache reuse）、`dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj`。
- **QA Rerun (2025-11-21, AA4-009):** `export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --nologo` produced 119/119 passing; targeted commands (`--filter FullyQualifiedName~PieceTreeBuilderTests|PieceTreeFactoryTests`, `FullyQualifiedName~CRLF_RandomFuzz_1000`) also green with fuzz logs redirected to `/tmp/aa4-009-fuzz-logs` (seed 123).

### CL7 – Cursor WordOps & Snippet Semantics
- **Investigator Notes (R40, 2025-11-26):** See `agent-team/handoffs/AA4-003-Audit.md` for the refreshed F1–F6 list. Highlights: (a) no `CursorsController`/marker recovery, so multi-cursor edits drift; (b) `WordOperations` lacks `WordNavigationType`, word-part logic, Intl segmentation, and delete contexts; (c) `TextModel` is missing the line helpers/`CursorConfiguration` required for column selection and select-line/home commands; (d) snippet controller/session only handles `${n:text}` and uses the wrong stickiness, so placeholder navigation/tabstops/context keys are absent; (e) command-layer + Markdown renderer tests were never ported even though the TestMatrix row reads “Verified”; (f) there is no Intl.Segmenter bridge or cursor/snippet fuzz coverage.
- **Proposed Fixes:** Deliver the four deltas called out in the audit (`#delta-2025-11-26-aa4-cl7-cursor-core`, `...-wordops`, `...-column-nav`, `...-snippet`) before closing the checklist, then add a coverage delta (`...-commands-tests`) to port TS suites/update TestMatrix. Each delta should flow through migration-log/indexes/changefeed + Sprint log once Porter lands the code.
- **Validation Hooks:** Port TS suites (`wordOperations*.test.ts`, `wordOperations.intl.test.ts`, `multicursor.test.ts`, `cursorColumnSelection.test.ts`, `snippetController2.test.ts`, `snippetSession.test.ts`) and add the pending Markdown renderer snapshot once snippet placeholders render. QA should downgrade CL7 rows in `tests/TextBuffer.Tests/TestMatrix.md` to “Gap” until those suites pass.

### CL8 – DocUI Find/Replace & Decorations
- **Investigator Notes (2025-11-26 refresh):** `agent-team/handoffs/AA4-004-Audit.md` now tracks four open gaps: (F1) Markdown renderer still bypasses search decorations and re-runs `FindMatches`, so owner filters, capture arrays, and minimap/overview metadata never render; (F2) capture metadata + replace preview strings stop at `FindModel` because `FindDecorations`/`ModelDecorationOptions` do not carry payloads; (F3) Intl.Segmenter + locale-aware whole-word rules remain unimplemented (`SearchTypes` + `FindUtilities` only honor ASCII separators); (F4) WordSeparator configuration/perf — `FindReplaceState` hardcodes separators, DocUI host never listens for option changes, and the classifier cache ignores locales so user settings cannot flow through. Scope tracking + scoped replace deltas (`#delta-2025-11-24-find-scope`, `#delta-2025-11-24-find-replace-scope`) stay valid; focus now shifts to Markdown renderer + Intl/word cache parity.
- **Proposed Fixes:**
	1. `#delta-2025-11-26-aa4-cl8-markdown` – have Markdown renderer consume search decorations (with owner filters + scope/minimap metadata) instead of re-running search.
	2. `#delta-2025-11-26-aa4-cl8-capture` – push capture arrays + replace previews into decoration metadata and expose an API for DocUI/Markdown snapshots.
	3. `#delta-2025-11-26-aa4-cl8-intl` – integrate an Intl-aware classifier (or ICU bridge) and plumb `wordSegmenterLocales`/`wordSeparators` from `TextModelResolvedOptions` through `FindReplaceState`, `DocUIFindController`, `SearchParams`, and `FindUtilities`.
	4. `#delta-2025-11-26-aa4-cl8-wordcache` – refresh caches/options (locale-aware keys, host option listeners, DocUI `UpdateOptions()` path) so user-configurable separators take effect without restarting.
- **Validation Hooks:** Extend `MarkdownRendererTests` (owner filter, replace preview, minimap annotations), `DocUIFindDecorationsTests.RendererUsesExistingDecorations`, `DocUIFindControllerTests.WordSeparatorsFollowOptionChanges`, `TextModelSearchTests.WholeWordIntlParity`, and re-run targeted suites with `export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --filter FullyQualifiedName~(MarkdownRendererTests|DocUIFindControllerTests|TextModelSearchTests) --nologo` once each delta lands. QA should also port TS `wordOperations.intl.test.ts` cases into the cursor + DocUI find selection suites referenced by CL7.
