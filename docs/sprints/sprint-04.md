# Sprint 04 – Alignment Remediation (WS1/WS2/WS3 Foundations)
- **Date Range:** 2025-11-27 ~ 2025-12-12
- **Changefeed Anchor:** `agent-team/indexes/README.md#delta-2025-11-26-sprint04`
- **Theme:** 把 `PORT-PT-Search-Plan.md`、`PORT-IntervalTree-Normalize.md` 与 `ALIGN-20251126-Plan.md` 融合为统一冲刺，聚焦 PieceTree 搜索、IntervalTree 延迟 normalize 以及 Range/Cursor/Test backlog 的前两阶段里程碑（M0/M1）。
- **RunSubAgent 节奏:** 继续执行“1 次 runSubAgent = 1 个闭环”的制度；任何角色在回报前必须先更新下方 `Progress Log`，并在更新 Task Board / TestMatrix / Migration Log 时引用本 sprint changefeed。

## Objectives
1. **Workstream 1 – PieceTreeModel.Search parity**：完成 tuple 缓存、CRLF bridge、SearchCache instrumentation，并交付 deterministic/fuzz/CRLF 覆盖（参照 `PORT-PT-Search-Plan.md` Step 1~5）。
2. **Workstream 2 & 4 – Helper/Cursor Blueprint**：由 Investigator 完成 Range/Selection（WS2）与 Cursor/Snippet（WS4）蓝图，Porter/QA 锁定实现与测试边界，为 12 月中旬 M2 交付铺路。
3. **Workstream 3 – IntervalTree Lazy Normalize**：Porter 实现 NodeFlags + delta + TextModel 集成，QA 建立 perf harness 并记录 50k decorations O(log n) 的基线。
4. **Workstream 5 – 高风险 deterministic/feature tests**：产出优先级清单、共用 harness、首批 ≥10 个 deterministic/feature 用例，确保 `tests/TextBuffer.Tests/TestMatrix.md` 记录 coverage delta。
5. **AA4 CL7/CL8 Gap Guardrails**：维持 [`docs/reports/migration-log.md#aa4-cl7-gap`](../reports/migration-log.md#aa4-cl7-gap) / [`docs/reports/migration-log.md#aa4-cl8-gap`](../reports/migration-log.md#aa4-cl8-gap) 与 [`#delta-2025-11-26-aa4-cl7-cursor-core`](../../agent-team/indexes/README.md#delta-2025-11-26-aa4-cl7-cursor-core) / [`#delta-2025-11-26-aa4-cl8-markdown`](../../agent-team/indexes/README.md#delta-2025-11-26-aa4-cl8-markdown) 之间的引用一致，在恢复 Cursor/Snippet/DocUI 状态前必须先更新这两处锚点。

## Deliverables & Tracking
| ID | Deliverable | Owner | Related Docs | Status |
| --- | --- | --- | --- | --- |
| WS1-PORT-SearchCore | `GetAccumulatedValue`/`NodeAt2` tuple 缓存 + SearchCache 失效策略 | Porter-CS | `PORT-PT-Search-Plan.md`, `src/TextBuffer/Core/PieceTreeModel.Search.cs`<br>Links: [`migration-log`](../reports/migration-log.md#ws1-port-searchcore), [`#delta-2025-11-26-ws1-searchcore`](../../agent-team/indexes/README.md#delta-2025-11-26-ws1-searchcore) | ✅ Done |
| WS1-PORT-CRLF | `_lastChangeBufferPos`/CRLF bridge（Append & CreateNewPieces） | Porter-CS | `PORT-PT-Search-Plan.md`, `src/TextBuffer/Core/PieceTreeModel.Edit.cs`<br>Links: [`migration-log`](../reports/migration-log.md#ws1-port-crlf), [`#delta-2025-11-26-sprint04-r1-r11`](../../agent-team/indexes/README.md#delta-2025-11-26-sprint04-r1-r11) | ✅ Done |
| WS1-QA | Deterministic/Fuzz/SearchOffset 扩展 + DEBUG 计数验证 | QA-Automation | `PieceTreeDeterministicTests.cs`, `PieceTreeFuzzHarnessTests.cs`, `PieceTreeSearchOffsetCacheTests.cs`<br>Links: [`migration-log`](../reports/migration-log.md#ws123-qa), [`#delta-2025-11-26-sprint04-r1-r11`](../../agent-team/indexes/README.md#delta-2025-11-26-sprint04-r1-r11) | ✅ Done |
| WS2-PORT | Range/Selection/TextPosition P0 helpers | Porter-CS | `INV-RangeSelection-GapReport.md`, `src/TextBuffer/Core/Range.cs`, `Selection.cs`, `TextPosition.cs`<br>Links: [`migration-log`](../reports/migration-log.md#ws2-port), [`#delta-2025-11-26-ws2-port`](../../agent-team/indexes/README.md#delta-2025-11-26-ws2-port) | ✅ Done |
| WS3-PORT | IntervalTree NodeFlags/delta + TextModel `AcceptReplace` 集成 | Porter-CS | `PORT-IntervalTree-Normalize.md`, `src/TextBuffer/Decorations/*.cs`, `TextModel.cs`<br>Links: [`migration-log`](../reports/migration-log.md#ws3-port-tree), [`#delta-2025-11-26-ws3-tree`](../../agent-team/indexes/README.md#delta-2025-11-26-ws3-tree) | ✅ Done |
| WS3-QA | 新 `IntervalTreeTests` + DocUI perf harness | QA-Automation | `tests/TextBuffer.Tests/IntervalTreeTests.cs`, `DocUI/IntervalTreePerfTests.cs`<br>Links: [`migration-log`](../reports/migration-log.md#ws123-qa), [`#delta-2025-11-26-sprint04-r1-r11`](../../agent-team/indexes/README.md#delta-2025-11-26-sprint04-r1-r11) | ✅ Done |
| WS2-INV | Range/Selection API gap inventory | Investigator-TS | `ALIGN-20251126-Plan.md`, `docs/reports/alignment-audit/02-core-support.md` | In Progress |
| WS4-INV | Cursor/Snippet blueprint & rollout plan | Investigator-TS | `ALIGN-20251126-Plan.md`, `agent-team/handoffs/AA4-003-Audit.md` | In Progress |
| WS4-PORT-Core | CursorConfiguration/CursorState/CursorContext + TrackedRange | Porter-CS | `INV-CursorSnippet-Blueprint.md`, `src/TextBuffer/Cursor/*.cs`<br>Links: [`migration-log`](../reports/migration-log.md#ws4-port-core), [`#delta-2025-11-26-ws4-port-core`](../../agent-team/indexes/README.md#delta-2025-11-26-ws4-port-core) | ✅ Done |
| WS4-PORT-Collection | CursorCollection 重写 + normalization | Porter-CS | `INV-CursorSnippet-Blueprint.md` | Planned |
| WS4-PORT-Snippet | SnippetController/Session parity | Porter-CS | `INV-CursorSnippet-Blueprint.md` | Planned |
| WS5-INV | High-risk deterministic test backlog | Investigator | `ALIGN-20251126-Plan.md`, `docs/reports/alignment-audit/07-core-tests.md`<br>Links: [`migration-log`](../reports/migration-log.md#ws5-inv), [`#delta-2025-11-26-ws5-test-backlog`](../../agent-team/indexes/README.md#delta-2025-11-26-ws5-test-backlog) | ✅ Done |
| WS5-PORT | Harness extensions + TS oracle ingestion | Porter | `WS5-INV-TestBacklog.md`, `WS5-PORT-Harness-Result.md`<br>Links: [`migration-log`](../reports/migration-log.md#sprint04-r1-r11), [`#delta-2025-11-26-sprint04-r1-r11`](../../agent-team/indexes/README.md#delta-2025-11-26-sprint04-r1-r11) | ✅ Done |
| WS5-QA | Implement high-risk suites (≥10 tests) | QA-Automation | `WS5-INV-TestBacklog.md`, `TestMatrix.md`<br>Links: [`migration-log`](../reports/migration-log.md#ws5-qa), [`#delta-2025-11-26-ws5-qa`](../../agent-team/indexes/README.md#delta-2025-11-26-ws5-qa) | ✅ Done |
| OPS-Index | 发布 `#delta-2025-11-26-sprint04` 之后的变更 feed | Info-Indexer | `agent-team/indexes/README.md` | Planned |
| OPS-Doc | Sprint/TestMatrix/Migration Log 同步 | DocMaintainer | `docs/sprints/sprint-04.md`, `tests/TextBuffer.Tests/TestMatrix.md`, `docs/reports/migration-log.md` | In Progress |

## Progress Log
> 规则：任何 runSubAgent 或关键手动操作完成后，负责成员需追加一行，记录日期、任务、输出与下一步。引用所有相关 changefeed。

| Run # | Date | Employee | Task | Result | Next Steps |
| --- | --- | --- | --- | --- | --- |
| R0 | 2025-11-26 | Main Agent | Sprint 04 建立 | 创建 `docs/sprints/sprint-04.md`、刷新 Task Board（Phase 8）并设定 changefeed anchor `#delta-2025-11-26-sprint04` | 等待 WS2-INV / WS4-INV 报告，触发下一轮 runSubAgent |
| R1 | 2025-11-26 | Porter-CS (Leo) | WS1-PORT-SearchCore | ✅ `GetAccumulatedValue` 混合实现 + DEBUG 计数器，365/365 通过。NodeAt2 tuple 重用推迟（CRLF 桥接依赖）。Links: [`migration-log`](../reports/migration-log.md#ws1-port-searchcore) / [`#delta-2025-11-26-ws1-searchcore`](../../agent-team/indexes/README.md#delta-2025-11-26-ws1-searchcore) | WS1-PORT-CRLF 实现 |
| R2 | 2025-11-26 | Porter-CS (Diego) | WS2-PORT | ✅ Range/Selection/TextPosition 完整 P0 API（75 个测试），440/440 通过。Links: [`migration-log`](../reports/migration-log.md#ws2-port) / [`#delta-2025-11-26-ws2-port`](../../agent-team/indexes/README.md#delta-2025-11-26-ws2-port) | WS4-PORT 可开始使用这些 helpers |
| R3 | 2025-11-26 | Porter-CS (Felix) | WS3-PORT-Tree | ✅ IntervalTree lazy normalize 全部完成（NodeFlags/delta/ResolveState/AcceptReplace），440/440 通过。Links: [`migration-log`](../reports/migration-log.md#ws3-port-tree) / [`#delta-2025-11-26-ws3-tree`](../../agent-team/indexes/README.md#delta-2025-11-26-ws3-tree) | WS3-PORT-TextModel 集成 + perf harness |
| R4 | 2025-11-26 | Investigator-TS (Evan) | WS5-INV | ✅ 测试 backlog 优先级清单：47 gaps / 106h，Top-10 P0 清单 + 共享 harness 需求。Links: [`migration-log`](../reports/migration-log.md#ws5-inv) / [`#delta-2025-11-26-ws5-test-backlog`](../../agent-team/indexes/README.md#delta-2025-11-26-ws5-test-backlog) | Porter 按优先级实现 |
| R5 | 2025-11-26 | QA-Automation (Sasha) | WS123-QA | ✅ 全量 440/440 + targeted reruns 验证，DEBUG 计数器确认可用，TestMatrix 更新。Links: [`migration-log`](../reports/migration-log.md#ws123-qa) / [`#delta-2025-11-26-sprint04-r1-r11`](../../agent-team/indexes/README.md#delta-2025-11-26-sprint04-r1-r11) | 继续 Sprint 04 后续任务 |
| R6 | 2025-11-26 | Porter-CS (Leo) | WS1-PORT-CRLF | ✅ Step 2 & 3 完成：`AppendToChangeBufferNode` hitCRLF + `CreateNewPieces` CRLF bridge placeholder，451/451 通过（+11 新测试）。Links: [`migration-log`](../reports/migration-log.md#ws1-port-crlf) / [`#delta-2025-11-26-sprint04-r1-r11`](../../agent-team/indexes/README.md#delta-2025-11-26-sprint04-r1-r11) | WS1-QA 可扩展 CRLF 覆盖 |
| R7 | 2025-11-26 | QA-Automation (Priya) | WS3-QA | ✅ IntervalTree 测试验证：`IntervalTreeTests` 13/13 + `IntervalTreePerfTests` 7/7，DEBUG 计数器可访问，TestMatrix 更新。Links: [`migration-log`](../reports/migration-log.md#sprint04-r1-r11) / [`#delta-2025-11-26-sprint04-r1-r11`](../../agent-team/indexes/README.md#delta-2025-11-26-sprint04-r1-r11) | 修复 per-model Sentinel 后重验 |
| R8 | 2025-11-26 | Porter-CS (Viktor) | WS4-PORT-Core | ✅ Cursor Stage 0：`CursorConfiguration` / `CursorState` / `CursorContext` 骨架 + TrackedRange 支持（25 新测试）。Links: [`migration-log`](../reports/migration-log.md#ws4-port-core) / [`#delta-2025-11-26-ws4-port-core`](../../agent-team/indexes/README.md#delta-2025-11-26-ws4-port-core) | WS4-PORT-Collection 实现 |
| R9 | 2025-11-26 | Porter-CS | IntervalTree-StackFix | ✅ `IntervalSearch` 迭代化修复栈溢出 + xunit.runner.json 禁用并行，496/496 通过。Links: [`migration-log`](../reports/migration-log.md#sprint04-r1-r11) / [`#delta-2025-11-26-sprint04-r1-r11`](../../agent-team/indexes/README.md#delta-2025-11-26-sprint04-r1-r11) | 继续 WS4/WS5 |
| R10 | 2025-11-26 | Porter-CS (Morgan) | WS5-PORT | ✅ 共享测试 Harness：`TestEditorBuilder`/`CursorTestHelper`/`WordTestUtils`/`SnapshotTestUtils` + 示例（44 新测试），540/540。Links: [`migration-log`](../reports/migration-log.md#sprint04-r1-r11) / [`#delta-2025-11-26-sprint04-r1-r11`](../../agent-team/indexes/README.md#delta-2025-11-26-sprint04-r1-r11) | WS5-QA 实现高风险测试 |
| R11 | 2025-11-26 | QA-Automation (Priya) | WS5-QA | ✅ 首批高风险测试：`PieceTreeBufferApiTests`(17) + `SearchRegressionTests`(9) + `IndentationTests`(19)，585/585(1 skip)。Links: [`migration-log`](../reports/migration-log.md#ws5-qa) / [`#delta-2025-11-26-ws5-qa`](../../agent-team/indexes/README.md#delta-2025-11-26-ws5-qa) | 继续 WS4-PORT-Collection |
